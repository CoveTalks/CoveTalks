<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Contact Speaker - CoveTalks</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="/Images/CoveTalks_Vertical.svg">
    
    <!-- Main Stylesheet -->
    <link rel="stylesheet" href="/css/main.css">
    
    <!-- Page-specific styles ONLY for unique elements -->
    <style>
        /* Speaker Profile Card - Unique to this page */
        .speaker-profile {
            text-align: center;
        }

        .speaker-avatar {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--color-deep), var(--color-calm));
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            font-weight: var(--font-weight-bold);
            margin: 0 auto var(--spacing-lg);
            overflow: hidden;
        }

        .speaker-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .speaker-name {
            font-size: 1.5rem;
            color: var(--color-deep);
            margin-bottom: var(--spacing-sm);
        }

        .speaker-location {
            color: var(--color-gray);
            margin-bottom: var(--spacing-md);
        }

        .speaker-rating {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-lg);
        }

        .stars {
            color: var(--color-warning);
            font-size: 1.2rem;
        }

        .speaker-bio {
            text-align: left;
            color: var(--color-gray);
            line-height: 1.6;
            margin-bottom: var(--spacing-lg);
            padding: var(--spacing-md);
            background: var(--color-foam);
            border-radius: 10px;
        }

        .speaker-specialties {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-sm);
            justify-content: center;
            margin-bottom: var(--spacing-lg);
        }

        .specialty-tag {
            background: #e8f4fd;
            color: var(--color-deep);
            padding: var(--spacing-xs) var(--spacing-md);
            border-radius: 15px;
            font-size: 0.85rem;
        }

        /* Contact Form Specific */
        .page-header {
            background: linear-gradient(135deg, var(--color-deep) 0%, var(--color-calm) 100%);
            color: white;
            padding: 8rem 0 4rem 0;
            margin-bottom: var(--spacing-xl);
            border-radius: 15px;
            text-align: center;
        }

        .page-header h1 {
            color: white;
            margin-bottom: var(--spacing-sm);
        }

        .page-header p {
            opacity: 0.9;
            font-size: 1.1rem;
        }

        .content-grid {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: var(--spacing-xl);
        }

        /* Form Elements - Using main.css base styles */
        .form-group {
            margin-bottom: var(--spacing-lg);
        }

        .form-group label {
            display: block;
            font-weight: var(--font-weight-bold);
            color: var(--color-gray-dark);
            margin-bottom: var(--spacing-sm);
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: var(--spacing-md);
            border: 2px solid var(--color-border);
            border-radius: 5px;
            font-size: 1rem;
            font-family: var(--font-primary);
            transition: border-color var(--transition-normal);
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--color-deep);
        }

        .form-group textarea {
            min-height: 200px;
            resize: vertical;
        }

        .form-help {
            font-size: 0.85rem;
            color: var(--color-gray);
            margin-top: var(--spacing-xs);
        }

        .required {
            color: var(--color-danger);
        }

        /* Message Templates */
        .template-buttons {
            display: flex;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-md);
            flex-wrap: wrap;
        }

        .template-btn {
            padding: var(--spacing-sm) var(--spacing-md);
            background: var(--color-foam);
            border: 1px solid var(--color-border);
            border-radius: 20px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .template-btn:hover {
            background: #e8f4fd;
            border-color: var(--color-deep);
        }

        /* Form Actions */
        .form-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: var(--spacing-xl);
            padding-top: var(--spacing-xl);
            border-top: 2px solid var(--color-bg-light);
        }

        .char-count {
            color: var(--color-gray);
            font-size: 0.85rem;
        }

        /* Info Box */
        .info-box {
            background: #e8f4fd;
            border-left: 4px solid var(--color-deep);
            padding: var(--spacing-md);
            border-radius: 5px;
            margin-bottom: var(--spacing-lg);
        }

        .info-box h4 {
            color: var(--color-deep);
            margin-bottom: var(--spacing-sm);
        }

        .info-box ul {
            margin-left: var(--spacing-lg);
            color: var(--color-gray);
        }

        /* Success Message */
        .success-message {
            background: #d4edda;
            color: var(--color-success);
            padding: var(--spacing-lg);
            border-radius: 10px;
            text-align: center;
            margin-bottom: var(--spacing-md);
        }

        .success-message h3 {
            margin-bottom: var(--spacing-sm);
        }

        /* Mobile Responsive Overrides */
        @media (max-width: 992px) {
            .content-grid {
                grid-template-columns: 1fr;
            }

            .speaker-profile {
                margin-bottom: var(--spacing-xl);
            }
        }

        @media (max-width: 768px) {
            .page-header h1 {
                font-size: 1.8rem;
            }

            .page-header p {
                font-size: 1rem;
            }

            .template-buttons {
                flex-direction: column;
            }

            .template-btn {
                width: 100%;
            }

            .form-actions {
                flex-direction: column;
                gap: var(--spacing-md);
            }

            .form-actions > div {
                width: 100%;
                display: flex;
                gap: var(--spacing-md);
            }

            .form-actions .btn {
                flex: 1;
            }
        }
    </style>
</head>
<body>
    <!-- Header will be auto-injected by header.js -->
    
    <!-- Main Content -->
    <main class="main-content">
        <div class="container">
            <!-- Page Header -->
            <div class="page-header">
                <h1>Contact Speaker</h1>
                <p>Send a message to connect with this speaker</p>
            </div>

            <!-- Loading State -->
            <div id="loadingState" class="loading">
                <div class="loading-spinner"></div>
                Loading speaker information...
            </div>

            <!-- Error State -->
            <div id="errorState" class="card hidden">
                <div class="empty-state">
                    <div class="empty-state-icon">⚠️</div>
                    <h3>Unable to Load Speaker</h3>
                    <p id="errorMessage">The speaker could not be found or you don't have permission to contact them.</p>
                    <a href="/members.html" class="btn btn-primary mt-3">
                        Browse Speakers
                    </a>
                </div>
            </div>

            <!-- Success State -->
            <div id="successState" class="card hidden">
                <div class="success-message">
                    <h3>✅ Message Sent Successfully!</h3>
                    <p>Your message has been delivered to the speaker.</p>
                </div>
                <div class="text-center mt-3">
                    <a href="/members.html" class="btn btn-secondary" style="margin-right: var(--spacing-md);">
                        Browse More Speakers
                    </a>
                    <a href="/dashboard.html" class="btn btn-primary">
                        Back to Dashboard
                    </a>
                </div>
            </div>

            <!-- Contact Form Content -->
            <div id="contactContent" class="content-grid hidden">
                <!-- Left Column - Speaker Profile -->
                <div>
                    <div class="card speaker-profile">
                        <div class="speaker-avatar" id="speakerAvatar">
                            ??
                        </div>
                        <h2 class="speaker-name" id="speakerName">Loading...</h2>
                        <div class="speaker-location" id="speakerLocation">Location</div>
                        <div class="speaker-rating" id="speakerRating">
                            <!-- Rating will be inserted here -->
                        </div>
                        <div class="speaker-bio" id="speakerBio">
                            Loading speaker information...
                        </div>
                        <div class="speaker-specialties" id="speakerSpecialties">
                            <!-- Specialties will be inserted here -->
                        </div>
                        <div class="action-buttons">
                            <a id="viewProfileBtn" href="#" class="btn btn-secondary btn-block">
                                View Full Profile
                            </a>
                            <button id="saveBtn" onclick="saveSpeaker()" class="btn btn-primary btn-block hidden mt-2">
                                ⭐ Save Speaker
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Right Column - Contact Form -->
                <div>
                    <div class="card">
                        <h2>Send Message</h2>
                        
                        <form id="contactForm">
                            <div class="form-group">
                                <label for="senderInfo">
                                    Your Information <span class="required">*</span>
                                </label>
                                <input type="text" id="senderInfo" readonly>
                                <p class="form-help">This is how you'll be identified to the speaker</p>
                            </div>

                            <div class="form-group">
                                <label for="contactSubject">
                                    Subject <span class="required">*</span>
                                </label>
                                <input type="text" id="contactSubject" required 
                                       placeholder="e.g., Speaking opportunity at Annual Conference">
                                <p class="form-help">Be specific about your inquiry</p>
                            </div>

                            <div class="form-group">
                                <label for="contactOpportunity">
                                    Related Opportunity (Optional)
                                </label>
                                <select id="contactOpportunity">
                                    <option value="">Select an opportunity...</option>
                                </select>
                                <p class="form-help">Link this message to a specific speaking opportunity</p>
                            </div>

                            <div class="form-group">
                                <label for="contactMessage">
                                    Message <span class="required">*</span>
                                </label>
                                <div class="template-buttons">
                                    <button type="button" class="template-btn" onclick="useTemplate('invitation')">
                                        📋 Speaking Invitation
                                    </button>
                                    <button type="button" class="template-btn" onclick="useTemplate('inquiry')">
                                        ❓ General Inquiry
                                    </button>
                                    <button type="button" class="template-btn" onclick="useTemplate('followup')">
                                        🔄 Follow-up
                                    </button>
                                </div>
                                <textarea id="contactMessage" required 
                                          placeholder="Hello [Speaker Name],&#10;&#10;I'm reaching out regarding..."
                                          onkeyup="updateCharCount()"></textarea>
                                <p class="form-help">Include event details, dates, audience, and compensation if applicable</p>
                            </div>

                            <div class="info-box">
                                <h4>Tips for a Great Message:</h4>
                                <ul>
                                    <li>Be specific about your event or inquiry</li>
                                    <li>Include relevant dates and location</li>
                                    <li>Mention the audience size and type</li>
                                    <li>Be clear about compensation and benefits</li>
                                    <li>Keep it professional but friendly</li>
                                </ul>
                            </div>

                            <div class="form-actions">
                                <span class="char-count" id="charCount">0 / 2000 characters</span>
                                <div>
                                    <button type="button" onclick="cancelMessage()" class="btn btn-secondary">
                                        Cancel
                                    </button>
                                    <button type="submit" class="btn btn-primary" id="sendBtn">
                                        Send Message
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <!-- Footer will be auto-injected by footer.js -->

    <!-- Load Supabase from CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Load config and Supabase client -->
    <script src="/js/config.js"></script>
    <script src="/js/supabase-client.js"></script>
    
    <!-- Load header and footer components -->
    <script src="/js/components/header.js"></script>
    <script src="/js/components/footer.js"></script>
    
    <!-- Page-specific JavaScript -->
    <script>
        // Page state
        let currentUser = null;
        let speakerData = null;
        let speakerId = null;
        let myOpportunities = [];
        let isSpeakerSaved = false;

        // Get speaker ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        speakerId = urlParams.get('id');

        // Message templates
        const templates = {
            invitation: `Dear [Speaker Name],

I hope this message finds you well. I'm writing to invite you to speak at our upcoming [Event Name] on [Date].

Event Details:
- Date: [Event Date]
- Location: [Venue/City or Virtual]
- Audience: [Audience Size and Type]
- Duration: [Speaking Time]
- Topic: [Requested Topic]

We believe your expertise in [Specialty] would be invaluable to our audience. We are offering [Compensation Details] for this engagement.

I would love to discuss this opportunity further at your convenience. Please let me know if you're interested and available.

Best regards,
[Your Name]`,
            
            inquiry: `Hello [Speaker Name],

I came across your profile and was impressed by your expertise in [Specialty]. I'm exploring potential speakers for [Event/Purpose] and would love to learn more about your availability and requirements.

Could we schedule a brief call to discuss potential collaboration opportunities?

Thank you for your time.

Best regards,
[Your Name]`,
            
            followup: `Hi [Speaker Name],

I wanted to follow up on my previous message regarding [Topic/Event]. I understand you may be busy, but I wanted to reiterate our interest in having you speak at our event.

Please let me know if you need any additional information or if you'd like to discuss this opportunity.

Looking forward to hearing from you.

Best regards,
[Your Name]`
        };

        // Initialize page
        async function initializePage() {
            try {
                // Check if speaker ID provided
                if (!speakerId) {
                    showError('No speaker ID provided');
                    return;
                }

                // Wait for Supabase
                await waitForSupabase();

                // Check authentication
                const session = await window.covetalks.checkAuth();
                if (!session) {
                    // Redirect to login with return URL
                    window.location.href = `/login.html?redirect=${encodeURIComponent(window.location.href)}`;
                    return;
                }

                // Get current user
                currentUser = await window.covetalks.getMemberProfile(session.user.id);
                
                // Set sender info
                document.getElementById('senderInfo').value = 
                    `${currentUser.name} (${currentUser.email})`;

                // Load speaker information
                await loadSpeakerInfo();

                // Load opportunities if organization
                if (currentUser.member_type === 'Organization') {
                    await loadOpportunities();
                    await checkIfSpeakerSaved();
                }

                // Show content
                document.getElementById('loadingState').classList.add('hidden');
                document.getElementById('contactContent').classList.remove('hidden');

            } catch (error) {
                console.error('Initialization error:', error);
                showError('Failed to load contact form');
            }
        }

        // Wait for Supabase client
        function waitForSupabase() {
            return new Promise((resolve) => {
                let attempts = 0;
                const maxAttempts = 20;
                
                function check() {
                    attempts++;
                    if (typeof window.covetalks !== 'undefined' && window.covetalks.supabase) {
                        resolve();
                    } else if (attempts < maxAttempts) {
                        setTimeout(check, 250);
                    } else {
                        showError('Failed to initialize. Please refresh the page.');
                    }
                }
                check();
            });
        }

        // Load speaker information
        async function loadSpeakerInfo() {
            try {
                speakerData = await window.covetalks.getMemberProfile(speakerId);
                
                if (!speakerData) {
                    showError('Speaker not found');
                    return;
                }

                // Display speaker info
                displaySpeakerInfo();

            } catch (error) {
                console.error('Error loading speaker:', error);
                showError('Failed to load speaker information');
            }
        }

        // Display speaker information
        function displaySpeakerInfo() {
            // Avatar
            const initials = speakerData.name ? 
                speakerData.name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2) : 
                '??';
            
            const avatarEl = document.getElementById('speakerAvatar');
            if (speakerData.profile_image_url) {
                avatarEl.innerHTML = `<img src="${speakerData.profile_image_url}" alt="${speakerData.name}">`;
            } else {
                avatarEl.textContent = initials;
            }

            // Basic info
            document.getElementById('speakerName').textContent = speakerData.name || 'Unknown Speaker';
            document.getElementById('speakerLocation').textContent = speakerData.location || 'Location not specified';

            // Rating
            const ratingEl = document.getElementById('speakerRating');
            if (speakerData.average_rating && speakerData.average_rating > 0) {
                const rating = speakerData.average_rating;
                const stars = '⭐'.repeat(Math.floor(rating)) + '☆'.repeat(5 - Math.floor(rating));
                ratingEl.innerHTML = `
                    <span class="stars">${stars}</span>
                    <span>${rating.toFixed(1)} (${speakerData.total_reviews || 0} reviews)</span>
                `;
            } else {
                ratingEl.innerHTML = '<span style="color: #999;">No ratings yet</span>';
            }

            // Bio
            document.getElementById('speakerBio').textContent = 
                speakerData.bio || 'No bio available';

            // Specialties
            const specialtiesEl = document.getElementById('speakerSpecialties');
            const specialties = speakerData.specialties || [];
            if (specialties.length > 0) {
                specialtiesEl.innerHTML = specialties.map(s => 
                    `<span class="specialty-tag">${s}</span>`
                ).join('');
            } else {
                specialtiesEl.innerHTML = '<span style="color: #999;">No specialties listed</span>';
            }

            // View profile button
            document.getElementById('viewProfileBtn').href = `/speaker-profile.html?id=${speakerId}`;
        }

        // Load opportunities
        async function loadOpportunities() {
            try {
                myOpportunities = await window.covetalks.getMyOpportunities('Open');
                
                const select = document.getElementById('contactOpportunity');
                select.innerHTML = '<option value="">Select an opportunity...</option>' +
                    myOpportunities.map(opp => 
                        `<option value="${opp.id}">${opp.title} - ${formatDate(opp.event_date)}</option>`
                    ).join('');
                    
            } catch (error) {
                console.error('Error loading opportunities:', error);
            }
        }

        // Check if speaker is saved
        async function checkIfSpeakerSaved() {
            try {
                isSpeakerSaved = await window.covetalks.checkIfSpeakerSaved(speakerId);
                
                const saveBtn = document.getElementById('saveBtn');
                if (!isSpeakerSaved) {
                    saveBtn.classList.remove('hidden');
                }
            } catch (error) {
                console.error('Error checking saved status:', error);
            }
        }

        // Save speaker
        async function saveSpeaker() {
            try {
                await window.covetalks.saveSpeaker(speakerId, '');
                
                const saveBtn = document.getElementById('saveBtn');
                saveBtn.textContent = '✅ Speaker Saved';
                saveBtn.disabled = true;
                
                isSpeakerSaved = true;
                
            } catch (error) {
                console.error('Error saving speaker:', error);
                alert('Failed to save speaker. Please try again.');
            }
        }

        // Use message template
        function useTemplate(templateName) {
            const template = templates[templateName];
            const message = document.getElementById('contactMessage');
            
            // Replace placeholders with actual data
            let personalizedTemplate = template
                .replace('[Speaker Name]', speakerData.name || 'Speaker')
                .replace('[Your Name]', currentUser.name || 'Your Name')
                .replace('[Specialty]', speakerData.specialties?.[0] || 'your area of expertise');
            
            message.value = personalizedTemplate;
            updateCharCount();
        }

        // Update character count
        function updateCharCount() {
            const message = document.getElementById('contactMessage');
            const charCount = document.getElementById('charCount');
            const count = message.value.length;
            
            charCount.textContent = `${count} / 2000 characters`;
            
            if (count > 2000) {
                charCount.style.color = 'var(--color-danger)';
                message.value = message.value.substring(0, 2000);
            } else {
                charCount.style.color = 'var(--color-gray)';
            }
        }

        // Handle form submission
        document.getElementById('contactForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const subject = document.getElementById('contactSubject').value;
            const message = document.getElementById('contactMessage').value;
            const opportunityId = document.getElementById('contactOpportunity').value || null;
            
            const sendBtn = document.getElementById('sendBtn');
            sendBtn.disabled = true;
            sendBtn.textContent = 'Sending...';
            
            try {
                await window.covetalks.sendMessage(speakerId, subject, message, opportunityId);
                
                // Show success message
                document.getElementById('contactContent').classList.add('hidden');
                document.getElementById('successState').classList.remove('hidden');
                
            } catch (error) {
                console.error('Error sending message:', error);
                alert('Failed to send message. Please try again.');
                
                sendBtn.disabled = false;
                sendBtn.textContent = 'Send Message';
            }
        });

        // Cancel message
        function cancelMessage() {
            if (confirm('Are you sure you want to cancel? Your message will not be saved.')) {
                window.history.back();
            }
        }

        // Show error
        function showError(message) {
            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('contactContent').classList.add('hidden');
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('errorState').classList.remove('hidden');
        }

        // Format date
        function formatDate(dateString) {
            if (!dateString) return 'Date TBD';
            return new Date(dateString).toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric',
                year: 'numeric'
            });
        }

        // Initialize on load
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializePage);
        } else {
            initializePage();
        }
    </script>
</body>
</html>