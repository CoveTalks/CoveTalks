<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Organization Dashboard - CoveTalks</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="/Images/CoveTalks_Vertical.svg">
    
    <!-- Main Stylesheet -->
    <link rel="stylesheet" href="/css/main.css">
    
    <!-- Page-specific styles ONLY for unique elements -->
    <style>
        /* Dashboard Header - Organization gradient */
        .dashboard-header {
            background: linear-gradient(135deg, var(--color-deep) 0%, var(--color-calm) 100%);
            color: white;
            padding: var(--spacing-2xl);
            margin-bottom: var(--spacing-xl);
            border-radius: 15px;
            margin-top: var(--spacing-xl);
        }

        .dashboard-header h1 {
            font-size: 2.5rem;
            margin-bottom: var(--spacing-sm);
            color: white;
        }

        .dashboard-header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        /* Stats Grid with Icons */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: var(--spacing-lg);
            margin-bottom: var(--spacing-xl);
        }

        .stat-card {
            background: white;
            padding: var(--spacing-lg);
            border-radius: 15px;
            box-shadow: var(--shadow-md);
            transition: all var(--transition-normal);
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
        }

        .stat-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, var(--color-deep), var(--color-calm));
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
            margin-bottom: var(--spacing-md);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: var(--font-weight-black);
            color: var(--color-deep);
            margin-bottom: 0.25rem;
        }

        .stat-label {
            color: var(--color-gray);
            font-size: 0.9rem;
        }

        /* Quick Actions Grid */
        .quick-actions {
            background: white;
            padding: var(--spacing-xl);
            border-radius: 15px;
            box-shadow: var(--shadow-md);
            margin-bottom: var(--spacing-xl);
        }

        .quick-actions h2 {
            color: var(--color-deep);
            margin-bottom: var(--spacing-lg);
        }

        .actions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--spacing-md);
        }

        .action-card {
            padding: var(--spacing-lg);
            border: 2px solid var(--color-border);
            border-radius: 10px;
            text-align: center;
            transition: all var(--transition-normal);
            cursor: pointer;
            text-decoration: none;
            color: #333;
        }

        .action-card:hover {
            border-color: var(--color-deep);
            background: var(--color-foam);
            transform: translateY(-3px);
        }

        .action-icon {
            font-size: 2rem;
            margin-bottom: var(--spacing-sm);
        }

        .action-title {
            font-weight: var(--font-weight-bold);
            color: var(--color-deep);
        }

        /* Dashboard Grid Layout */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: var(--spacing-xl);
        }

        /* Section Cards */
        .section-card {
            background: white;
            padding: var(--spacing-xl);
            border-radius: 15px;
            box-shadow: var(--shadow-md);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-lg);
        }

        .section-header h2 {
            color: var(--color-deep);
        }

        /* Applications Table */
        .applications-table {
            width: 100%;
            border-collapse: collapse;
        }

        .applications-table th {
            text-align: left;
            padding: 0.75rem;
            background: var(--color-foam);
            color: var(--color-gray);
            font-weight: var(--font-weight-bold);
            font-size: 0.9rem;
            border-bottom: 2px solid var(--color-border);
        }

        .applications-table td {
            padding: 0.75rem;
            border-bottom: 1px solid var(--color-border);
        }

        .applications-table tr:hover {
            background: var(--color-foam);
        }

        .applicant-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .applicant-avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--color-deep), var(--color-calm));
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            font-weight: var(--font-weight-bold);
        }

        /* Opportunities List */
        .opportunity-item {
            padding: var(--spacing-md);
            border-bottom: 1px solid var(--color-border);
            transition: background var(--transition-fast);
        }

        .opportunity-item:hover {
            background: var(--color-foam);
        }

        .opportunity-item:last-child {
            border-bottom: none;
        }

        .opportunity-title {
            font-weight: var(--font-weight-bold);
            color: var(--color-deep);
            margin-bottom: 0.25rem;
        }

        .opportunity-meta {
            display: flex;
            gap: var(--spacing-md);
            font-size: 0.85rem;
            color: var(--color-gray);
            margin-bottom: var(--spacing-sm);
        }

        .opportunity-stats {
            display: flex;
            gap: var(--spacing-md);
            font-size: 0.85rem;
        }

        .opportunity-stat {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        /* Activity Feed */
        .activity-item {
            display: flex;
            align-items: start;
            gap: var(--spacing-md);
            padding: var(--spacing-md) 0;
            border-bottom: 1px solid var(--color-border);
        }

        .activity-item:last-child {
            border-bottom: none;
        }

        .activity-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--color-bg-light);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .activity-content {
            flex: 1;
        }

        .activity-text {
            color: #333;
            margin-bottom: 0.25rem;
        }

        .activity-time {
            font-size: 0.85rem;
            color: var(--color-gray-light);
        }

        /* Responsive Design */
        @media (max-width: 992px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .dashboard-header h1 {
                font-size: 1.8rem;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .actions-grid {
                grid-template-columns: 1fr;
            }

            .dashboard-header {
                margin-top: var(--spacing-md);
                padding: var(--spacing-lg);
            }
        }

        @media (max-width: 576px) {
            .dashboard-header h1 {
                font-size: 1.5rem;
            }

            .section-header {
                flex-direction: column;
                gap: var(--spacing-md);
                align-items: flex-start;
            }

            .applications-table {
                font-size: 0.85rem;
            }
        }
    </style>
</head>
<body>
    <!-- Header will be auto-injected by header.js -->

    <!-- Main Content -->
    <main class="main-content">
        <div class="container">
            <!-- Dashboard Header -->
            <div class="dashboard-header">
                <h1>Welcome back, <span id="orgName">Organization</span>!</h1>
                <p>Manage your speaking opportunities and connect with speakers</p>
            </div>

            <!-- Stats Grid -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon">üì¢</div>
                    <div class="stat-value" id="activeOpportunities">0</div>
                    <div class="stat-label">Active Opportunities</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üìù</div>
                    <div class="stat-value" id="totalApplications">0</div>
                    <div class="stat-label">Total Applications</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">‚è≥</div>
                    <div class="stat-value" id="pendingReviews">0</div>
                    <div class="stat-label">Pending Reviews</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">‚≠ê</div>
                    <div class="stat-value" id="savedSpeakers">0</div>
                    <div class="stat-label">Saved Speakers</div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="quick-actions">
                <h2>Quick Actions</h2>
                <div class="actions-grid">
                    <a href="/post-opportunity.html" class="action-card">
                        <div class="action-icon">‚ûï</div>
                        <div class="action-title">Post New Opportunity</div>
                    </a>
                    <a href="/members.html" class="action-card">
                        <div class="action-icon">üîç</div>
                        <div class="action-title">Browse Speakers</div>
                    </a>
                    <a href="/my-opportunities.html" class="action-card">
                        <div class="action-icon">üìã</div>
                        <div class="action-title">Manage Opportunities</div>
                    </a>
                    <a href="/saved-speakers.html" class="action-card">
                        <div class="action-icon">üíæ</div>
                        <div class="action-title">View Saved Speakers</div>
                    </a>
                </div>
            </div>

            <!-- Dashboard Grid -->
            <div class="dashboard-grid">
                <!-- Left Column -->
                <div>
                    <!-- Recent Applications -->
                    <div class="section-card">
                        <div class="section-header">
                            <h2>Recent Applications</h2>
                            <a href="/my-opportunities.html" class="btn btn-primary">View All</a>
                        </div>
                        <div id="recentApplicationsContent">
                            <div class="loading">
                                <div class="loading-spinner"></div>
                                Loading applications...
                            </div>
                        </div>
                    </div>

                    <!-- Active Opportunities -->
                    <div class="section-card mt-4">
                        <div class="section-header">
                            <h2>Your Active Opportunities</h2>
                            <a href="/post-opportunity.html" class="btn btn-success">Post New</a>
                        </div>
                        <div id="activeOpportunitiesContent">
                            <div class="loading">
                                <div class="loading-spinner"></div>
                                Loading opportunities...
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Column -->
                <div>
                    <!-- Recent Activity -->
                    <div class="section-card">
                        <h2>Recent Activity</h2>
                        <div id="recentActivityContent">
                            <div class="loading">
                                <div class="loading-spinner"></div>
                                Loading activity...
                            </div>
                        </div>
                    </div>

                    <!-- Quick Stats -->
                    <div class="section-card mt-4">
                        <h2>This Month</h2>
                        <div id="monthlyStats">
                            <div class="opportunity-item">
                                <div class="opportunity-meta">
                                    <span>üìù New Applications: <strong id="monthApplications">0</strong></span>
                                </div>
                                <div class="opportunity-meta">
                                    <span>‚úÖ Accepted: <strong id="monthAccepted">0</strong></span>
                                </div>
                                <div class="opportunity-meta">
                                    <span>üëÅ Profile Views: <strong id="monthViews">0</strong></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <!-- Footer will be auto-injected by footer.js -->

    <!-- Load Supabase from CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Load config and Supabase client -->
    <script src="/js/config.js"></script>
    <script src="/js/supabase-client.js"></script>
    
    <!-- Load header and footer components -->
    <script src="/js/components/header.js"></script>
    <script src="/js/components/footer.js"></script>
    
    <!-- Page-specific JavaScript -->
    <script>
        // Page state
        let currentUser = null;
        let organizationData = null;

        // Initialize page
        async function initializePage() {
            try {
                // Wait for Supabase
                await waitForSupabase();
                
                // Check authentication
                const session = await window.covetalks.checkAuth();
                if (!session) {
                    window.location.href = '/login.html';
                    return;
                }

                // Get user profile
                currentUser = await window.covetalks.getMemberProfile(session.user.id);
                if (!currentUser || currentUser.member_type !== 'Organization') {
                    // Redirect non-organization users to appropriate dashboard
                    window.location.href = '/dashboard.html';
                    return;
                }

                // Update UI with user info
                updateUserInterface();

                // Load dashboard data
                await loadDashboardData();

            } catch (error) {
                console.error('Initialization error:', error);
                alert('Failed to load dashboard. Please try refreshing the page.');
            }
        }

        // Wait for Supabase client
        function waitForSupabase() {
            return new Promise((resolve) => {
                let attempts = 0;
                const maxAttempts = 20;
                
                function check() {
                    attempts++;
                    if (typeof window.covetalks !== 'undefined' && window.covetalks.supabase) {
                        resolve();
                    } else if (attempts < maxAttempts) {
                        setTimeout(check, 250);
                    } else {
                        console.error('Failed to initialize Supabase client');
                        window.location.href = '/login.html';
                    }
                }
                check();
            });
        }

        // Update user interface
        function updateUserInterface() {
            // Update organization name
            document.getElementById('orgName').textContent = currentUser.name || 'Organization';
        }

        // Load dashboard data
        async function loadDashboardData() {
            try {
                // Load all data in parallel
                const [
                    opportunities,
                    savedSpeakers,
                    recentApplications,
                    recentActivity
                ] = await Promise.all([
                    loadOpportunities(),
                    loadSavedSpeakersCount(),
                    loadRecentApplications(),
                    loadRecentActivity()
                ]);

                // Update stats
                updateDashboardStats(opportunities, recentApplications);

                // Display active opportunities
                displayActiveOpportunities(opportunities);

                // Display recent applications
                displayRecentApplications(recentApplications);

                // Display recent activity
                displayRecentActivity(recentActivity);

            } catch (error) {
                console.error('Error loading dashboard data:', error);
            }
        }

        // Load opportunities
        async function loadOpportunities() {
            try {
                const opportunities = await window.covetalks.getMyOpportunities();
                return opportunities || [];
            } catch (error) {
                console.error('Error loading opportunities:', error);
                return [];
            }
        }

        // Load saved speakers count
        async function loadSavedSpeakersCount() {
            try {
                const savedSpeakers = await window.covetalks.getSavedSpeakers();
                document.getElementById('savedSpeakers').textContent = savedSpeakers.length;
                return savedSpeakers.length;
            } catch (error) {
                console.error('Error loading saved speakers:', error);
                return 0;
            }
        }

        // Load recent applications
        async function loadRecentApplications() {
            try {
                const opportunities = await window.covetalks.getMyOpportunities();
                let allApplications = [];
                
                // Get applications for each opportunity
                for (const opp of opportunities.slice(0, 5)) {
                    const applications = await window.covetalks.getOpportunityApplications(opp.id);
                    allApplications = allApplications.concat(
                        applications.map(app => ({ ...app, opportunity: opp }))
                    );
                }
                
                // Sort by created_at and limit to recent 10
                allApplications.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
                return allApplications.slice(0, 10);
            } catch (error) {
                console.error('Error loading applications:', error);
                return [];
            }
        }

        // Load recent activity
        async function loadRecentActivity() {
            try {
                const activity = await window.covetalks.getRecentActivity(currentUser.id, 10);
                return activity || [];
            } catch (error) {
                console.error('Error loading activity:', error);
                return [];
            }
        }

        // Update dashboard stats
        function updateDashboardStats(opportunities, applications) {
            // Active opportunities
            const activeOps = opportunities.filter(o => o.status === 'Open').length;
            document.getElementById('activeOpportunities').textContent = activeOps;
            
            // Total applications
            document.getElementById('totalApplications').textContent = applications.length;
            
            // Pending reviews
            const pendingCount = applications.filter(a => a.status === 'Pending').length;
            document.getElementById('pendingReviews').textContent = pendingCount;
            
            // Monthly stats
            const now = new Date();
            const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
            
            const monthlyApps = applications.filter(a => 
                new Date(a.created_at) >= monthStart
            );
            
            document.getElementById('monthApplications').textContent = monthlyApps.length;
            document.getElementById('monthAccepted').textContent = 
                monthlyApps.filter(a => a.status === 'Accepted').length;
        }

        // Display active opportunities
        function displayActiveOpportunities(opportunities) {
            const container = document.getElementById('activeOpportunitiesContent');
            const activeOps = opportunities.filter(o => o.status === 'Open').slice(0, 5);
            
            if (activeOps.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üì¢</div>
                        <p>No active opportunities</p>
                        <a href="/post-opportunity.html" class="btn btn-primary mt-3">
                            Post Your First Opportunity
                        </a>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = activeOps.map(opp => `
                <div class="opportunity-item">
                    <div class="opportunity-title">${opp.title}</div>
                    <div class="opportunity-meta">
                        <span>üìÖ ${formatDate(opp.event_date)}</span>
                        <span>üìç ${opp.location || 'TBD'}</span>
                    </div>
                    <div class="opportunity-stats">
                        <div class="opportunity-stat">
                            <span>üìù</span>
                            <span>${opp.applications?.count || 0} applications</span>
                        </div>
                        <div class="opportunity-stat">
                            <span>üí∞</span>
                            <span>${opp.compensation_amount ? `$${opp.compensation_amount}` : 'Volunteer'}</span>
                        </div>
                    </div>
                    <div class="mt-2">
                        <a href="/opportunity-details.html?id=${opp.id}" class="btn btn-secondary btn-sm">
                            View Details
                        </a>
                    </div>
                </div>
            `).join('');
        }

        // Display recent applications
        function displayRecentApplications(applications) {
            const container = document.getElementById('recentApplicationsContent');
            
            if (applications.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìù</div>
                        <p>No applications yet</p>
                        <p style="font-size: 0.9rem; margin-top: var(--spacing-sm);">
                            Applications will appear here when speakers apply to your opportunities
                        </p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = `
                <table class="applications-table">
                    <thead>
                        <tr>
                            <th>Speaker</th>
                            <th>Opportunity</th>
                            <th>Status</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${applications.slice(0, 5).map(app => {
                            const speaker = app.speaker || {};
                            const initials = speaker.name ? 
                                speaker.name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2) : 
                                '?';
                            
                            const statusClass = app.status.toLowerCase();
                            
                            return `
                                <tr>
                                    <td>
                                        <div class="applicant-info">
                                            <div class="applicant-avatar">${initials}</div>
                                            <div>
                                                <div>${speaker.name || 'Unknown'}</div>
                                                <div style="font-size: 0.85rem; color: var(--color-gray);">
                                                    ${speaker.location || 'Location not specified'}
                                                </div>
                                            </div>
                                        </div>
                                    </td>
                                    <td>${app.opportunity?.title || 'Unknown'}</td>
                                    <td>
                                        <span class="status-badge ${statusClass}">${app.status}</span>
                                    </td>
                                    <td>
                                        <a href="/application-review.html?id=${app.id}" class="btn btn-primary btn-sm">
                                            Review
                                        </a>
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
        }

        // Display recent activity
        function displayRecentActivity(activities) {
            const container = document.getElementById('recentActivityContent');
            
            if (activities.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìä</div>
                        <p>No recent activity</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = activities.slice(0, 5).map(activity => {
                const icon = getActivityIcon(activity.activity_type);
                const text = getActivityText(activity);
                
                return `
                    <div class="activity-item">
                        <div class="activity-icon">${icon}</div>
                        <div class="activity-content">
                            <div class="activity-text">${text}</div>
                            <div class="activity-time">${formatTimeAgo(activity.created_at)}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Get activity icon
        function getActivityIcon(type) {
            const icons = {
                'opportunity_posted': 'üì¢',
                'application_received': 'üìù',
                'application_reviewed': '‚úÖ',
                'speaker_saved': '‚≠ê',
                'profile_view': 'üëÅ',
                'default': 'üìå'
            };
            return icons[type] || icons.default;
        }

        // Get activity text
        function getActivityText(activity) {
            const texts = {
                'opportunity_posted': 'Posted a new opportunity',
                'application_received': 'Received a new application',
                'application_reviewed': 'Reviewed an application',
                'speaker_saved': 'Saved a speaker',
                'profile_view': 'Someone viewed your profile'
            };
            return texts[activity.activity_type] || 'New activity';
        }

        // Format date
        function formatDate(dateString) {
            if (!dateString) return 'Date TBD';
            return new Date(dateString).toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric',
                year: 'numeric'
            });
        }

        // Format time ago
        function formatTimeAgo(dateString) {
            if (!dateString) return 'Recently';
            const date = new Date(dateString);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins} min${diffMins > 1 ? 's' : ''} ago`;
            if (diffHours < 24) return `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
            if (diffDays < 30) return `${diffDays} day${diffDays > 1 ? 's' : ''} ago`;
            return formatDate(dateString);
        }

        // Initialize on load
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializePage);
        } else {
            initializePage();
        }
    </script>
</body>
</html>