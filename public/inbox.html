<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inbox - CoveTalks</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="/Images/CoveTalks_Vertical.svg">
    
    <!-- Main Stylesheet -->
    <link rel="stylesheet" href="/css/main.css">
    
    <!-- Page-specific styles ONLY for unique elements -->
    <style>
        /* Page Header - Unique to inbox */
        .inbox-header {
            background: linear-gradient(135deg, var(--color-deep) 0%, var(--color-calm) 100%);
            color: white;
            padding: var(--spacing-2xl) var(--spacing-xl);
            margin: var(--spacing-xl) 0;
            border-radius: 15px;
        }

        .inbox-header h1 {
            color: white;
            margin-bottom: var(--spacing-md);
        }

        .inbox-stats {
            display: flex;
            gap: var(--spacing-xl);
            flex-wrap: wrap;
        }

        .inbox-stat {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            background: rgba(255, 255, 255, 0.2);
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: 20px;
            font-size: 0.9rem;
        }

        /* Inbox Layout */
        .inbox-container {
            display: grid;
            grid-template-columns: 250px 1fr;
            gap: var(--spacing-xl);
        }

        /* Sidebar */
        .inbox-sidebar {
            position: sticky;
            top: calc(var(--header-height) + var(--spacing-md));
            height: fit-content;
        }

        .inbox-menu {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .inbox-menu li {
            margin-bottom: var(--spacing-sm);
        }

        .inbox-menu a {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--spacing-md);
            color: #333;
            text-decoration: none;
            border-radius: 10px;
            transition: all var(--transition-normal);
        }

        .inbox-menu a:hover {
            background: var(--color-foam);
        }

        .inbox-menu a.active {
            background: #e8f4fd;
            color: var(--color-deep);
            font-weight: var(--font-weight-bold);
        }

        .menu-count {
            background: var(--color-danger);
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 10px;
            font-size: 0.75rem;
            font-weight: var(--font-weight-bold);
            min-width: 20px;
            text-align: center;
        }

        /* Messages Container */
        .messages-container {
            background: white;
            border-radius: 15px;
            box-shadow: var(--shadow-md);
            overflow: hidden;
        }

        .messages-header {
            padding: var(--spacing-lg);
            border-bottom: 2px solid var(--color-foam);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: var(--spacing-md);
        }

        .messages-header h2 {
            color: var(--color-deep);
            margin: 0;
        }

        /* Search Box */
        .search-box {
            position: relative;
            width: 300px;
            max-width: 100%;
        }

        .search-box input {
            width: 100%;
            padding: var(--spacing-sm) var(--spacing-md) var(--spacing-sm) 2.5rem;
            border: 2px solid var(--color-border);
            border-radius: 20px;
            font-size: 0.9rem;
            transition: border-color var(--transition-fast);
        }

        .search-box input:focus {
            outline: none;
            border-color: var(--color-deep);
            box-shadow: 0 0 0 3px rgba(21, 84, 135, 0.1);
        }

        .search-icon {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--color-gray-light);
        }

        .search-icon::before {
            content: "üîç";
        }

        /* Message Item */
        .message-item {
            padding: var(--spacing-lg);
            border-bottom: 1px solid var(--color-foam);
            transition: background var(--transition-fast);
            cursor: pointer;
            display: flex;
            gap: var(--spacing-md);
            position: relative;
        }

        .message-item:hover {
            background: var(--color-foam);
        }

        .message-item:hover .message-actions-quick {
            opacity: 1;
        }

        .message-item.unread {
            background: #f0f8ff;
            border-left: 4px solid var(--color-deep);
        }

        .message-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--color-deep), var(--color-calm));
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: var(--font-weight-bold);
            flex-shrink: 0;
        }

        .message-content {
            flex: 1;
            min-width: 0;
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: var(--spacing-sm);
            gap: var(--spacing-md);
        }

        .message-sender {
            font-weight: var(--font-weight-bold);
            color: #333;
        }

        .message-sender.unread {
            color: var(--color-deep);
        }

        .message-time {
            font-size: 0.85rem;
            color: var(--color-gray-light);
            white-space: nowrap;
        }

        .message-subject {
            font-weight: var(--font-weight-medium);
            color: var(--color-gray-dark);
            margin-bottom: 0.25rem;
        }

        .message-preview {
            color: var(--color-gray);
            font-size: 0.9rem;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .message-meta {
            display: flex;
            gap: var(--spacing-md);
            margin-top: var(--spacing-sm);
            font-size: 0.85rem;
            color: var(--color-gray-light);
        }

        .message-tag {
            background: #e8f4fd;
            color: var(--color-deep);
            padding: 0.25rem 0.5rem;
            border-radius: 10px;
            font-size: 0.75rem;
        }

        /* Quick Actions */
        .message-actions-quick {
            position: absolute;
            right: var(--spacing-md);
            bottom: var(--spacing-md);
            display: flex;
            gap: var(--spacing-sm);
            opacity: 0;
            transition: opacity var(--transition-fast);
        }

        .quick-action-btn {
            padding: 0.4rem 0.8rem;
            background: white;
            border: 1px solid var(--color-border);
            border-radius: 15px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .quick-action-btn:hover {
            background: var(--color-deep);
            color: white;
            border-color: var(--color-deep);
        }

        /* Message View */
        .message-view {
            padding: var(--spacing-xl);
            display: none;
        }

        .message-view.active {
            display: block;
        }

        .message-view-header {
            margin-bottom: var(--spacing-xl);
        }

        .message-view-subject {
            font-size: 1.5rem;
            color: var(--color-deep);
            margin-bottom: var(--spacing-md);
        }

        .message-view-meta {
            display: flex;
            gap: var(--spacing-xl);
            color: var(--color-gray);
            font-size: 0.9rem;
            padding: var(--spacing-md);
            background: var(--color-foam);
            border-radius: 10px;
            margin-bottom: var(--spacing-lg);
            flex-wrap: wrap;
        }

        .message-view-body {
            background: white;
            padding: var(--spacing-xl);
            border: 2px solid var(--color-foam);
            border-radius: 10px;
            line-height: 1.8;
            white-space: pre-wrap;
            margin-bottom: var(--spacing-xl);
            min-height: 200px;
        }

        .message-actions {
            display: flex;
            gap: var(--spacing-md);
            flex-wrap: wrap;
        }

        /* Recipient Autocomplete */
        .recipient-search-container {
            position: relative;
        }

        #recipientSearch {
            width: 100%;
            padding: var(--spacing-md);
            padding-left: 2.5rem;
            border: 2px solid var(--color-border);
            border-radius: 5px;
            font-size: 1rem;
            transition: border-color var(--transition-normal);
        }

        #recipientSearch:focus {
            outline: none;
            border-color: var(--color-deep);
            box-shadow: 0 0 0 3px rgba(21, 85, 136, 0.1);
        }

        .search-input-icon {
            position: absolute;
            left: var(--spacing-md);
            top: 50%;
            transform: translateY(-50%);
            color: var(--color-gray-light);
            font-size: 1.1rem;
        }

        .selected-recipient {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-sm);
            background: var(--color-foam);
            border-radius: 5px;
        }

        .recipient-tag {
            background: #e8f4fd;
            color: var(--color-deep);
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: 20px;
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-sm);
            font-weight: var(--font-weight-medium);
        }

        .remove-btn {
            background: none;
            border: none;
            color: var(--color-deep);
            font-size: 1.2rem;
            cursor: pointer;
            padding: 0;
            margin-left: var(--spacing-sm);
            line-height: 1;
            transition: color var(--transition-fast);
        }

        .remove-btn:hover {
            color: var(--color-danger);
        }

        .recipient-suggestions {
            position: absolute;
            top: calc(100% + 5px);
            left: 0;
            right: 0;
            background: white;
            border: 2px solid var(--color-border);
            border-radius: 5px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 100;
            box-shadow: var(--shadow-lg);
        }

        .suggestion-item {
            padding: var(--spacing-md);
            cursor: pointer;
            border-bottom: 1px solid var(--color-foam);
            transition: background var(--transition-fast);
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
        }

        .suggestion-item:hover {
            background: var(--color-foam);
        }

        .suggestion-item:last-child {
            border-bottom: none;
        }

        .suggestion-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--color-deep), var(--color-calm));
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: var(--font-weight-bold);
            font-size: 0.9rem;
        }

        .suggestion-info {
            flex: 1;
        }

        .suggestion-name {
            font-weight: var(--font-weight-bold);
            color: #333;
            margin-bottom: 0.25rem;
        }

        .suggestion-email {
            font-size: 0.85rem;
            color: var(--color-gray);
        }

        .member-type-badge {
            background: var(--color-foam);
            padding: 0.25rem 0.5rem;
            border-radius: 10px;
            font-size: 0.75rem;
            color: var(--color-gray);
            white-space: nowrap;
        }

        .member-type-badge.speaker {
            background: #e8f4fd;
            color: var(--color-deep);
        }

        .member-type-badge.organization {
            background: #fff4e6;
            color: var(--color-sand);
        }

        /* Reply Thread */
        .message-thread {
            background: var(--color-foam);
            padding: var(--spacing-md);
            border-left: 3px solid var(--color-deep);
            margin-bottom: var(--spacing-md);
            border-radius: 5px;
        }

        .message-thread-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-sm);
        }

        .message-thread-title {
            font-size: 0.85rem;
            color: var(--color-gray);
            font-weight: var(--font-weight-bold);
        }

        .message-thread-date {
            font-size: 0.8rem;
            color: var(--color-gray-light);
        }

        .message-thread-content {
            color: var(--color-gray-dark);
            font-size: 0.9rem;
            line-height: 1.5;
            max-height: 150px;
            overflow-y: auto;
        }

        /* Notification Toast */
        .notification {
            position: fixed;
            top: 100px;
            right: 20px;
            padding: var(--spacing-md) var(--spacing-lg);
            border-radius: 10px;
            box-shadow: var(--shadow-xl);
            z-index: 3000;
            animation: slideInRight 0.3s ease;
            font-weight: var(--font-weight-medium);
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
        }

        .notification-success {
            background: var(--color-success);
            color: white;
        }

        .notification-error {
            background: var(--color-danger);
            color: white;
        }

        .notification-info {
            background: var(--color-deep);
            color: white;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        /* Mobile Responsive Overrides */
        @media (max-width: 992px) {
            .inbox-container {
                grid-template-columns: 1fr;
            }

            .inbox-sidebar {
                position: static;
                margin-bottom: var(--spacing-xl);
            }

            .inbox-menu {
                display: flex;
                gap: var(--spacing-sm);
                overflow-x: auto;
                padding-bottom: var(--spacing-sm);
            }

            .inbox-menu li {
                margin-bottom: 0;
            }

            .inbox-menu a {
                white-space: nowrap;
                padding: var(--spacing-sm) var(--spacing-md);
            }
        }

        @media (max-width: 768px) {
            .inbox-header {
                padding: var(--spacing-lg);
            }

            .inbox-header h1 {
                font-size: 1.5rem;
            }

            .inbox-stats {
                gap: var(--spacing-sm);
            }

            .inbox-stat {
                font-size: 0.8rem;
                padding: 0.25rem 0.5rem;
            }

            .messages-header {
                flex-direction: column;
                align-items: stretch;
            }

            .search-box {
                width: 100%;
            }

            .message-item {
                padding: var(--spacing-md);
            }

            .message-avatar {
                width: 40px;
                height: 40px;
                font-size: 0.9rem;
            }

            .message-header {
                flex-direction: column;
                gap: var(--spacing-xs);
            }

            .message-view-meta {
                flex-direction: column;
                gap: var(--spacing-sm);
            }

            .message-actions-quick {
                opacity: 1;
                position: static;
                margin-top: var(--spacing-sm);
                justify-content: flex-end;
            }

            .modal-content {
                width: 95%;
                padding: var(--spacing-lg);
            }
        }

        @media (max-width: 576px) {
            .message-view-subject {
                font-size: 1.25rem;
            }

            .message-view-body {
                padding: var(--spacing-md);
            }

            .message-actions {
                flex-direction: column;
            }

            .message-actions .btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <!-- Header will be auto-injected by header.js -->
    
    <!-- Main Content -->
    <main class="main-content">
        <div class="container">
            <!-- Page Header -->
            <div class="inbox-header">
                <h1>Inbox</h1>
                <div class="inbox-stats">
                    <div class="inbox-stat">
                        <span>Total:</span>
                        <strong id="totalMessages">0</strong>
                    </div>
                    <div class="inbox-stat">
                        <span>Unread:</span>
                        <strong id="unreadMessages">0</strong>
                    </div>
                    <div class="inbox-stat">
                        <span>Sent:</span>
                        <strong id="sentMessages">0</strong>
                    </div>
                </div>
            </div>

            <!-- Inbox Container -->
            <div class="inbox-container">
                <!-- Sidebar -->
                <div class="inbox-sidebar card">
                    <button onclick="showComposeModal()" class="btn btn-primary btn-block mb-3">
                        Compose
                    </button>
                    <ul class="inbox-menu">
                        <li>
                            <a href="#" class="active" onclick="filterMessages('inbox'); return false;">
                                <span>Inbox</span>
                                <span class="menu-count hidden" id="inboxCount">0</span>
                            </a>
                        </li>
                        <li>
                            <a href="#" onclick="filterMessages('sent'); return false;">
                                <span>Sent</span>
                            </a>
                        </li>
                        <li>
                            <a href="#" onclick="filterMessages('archived'); return false;">
                                <span>Archived</span>
                            </a>
                        </li>
                    </ul>
                </div>

                <!-- Messages Container -->
                <div class="messages-container">
                    <!-- Messages Header -->
                    <div class="messages-header">
                        <h2 id="folderTitle">Inbox</h2>
                        <div class="search-box">
                            <span class="search-icon"></span>
                            <input type="text" id="searchMessages" placeholder="Search messages..." onkeyup="searchMessages()">
                        </div>
                    </div>

                    <!-- Messages List -->
                    <div id="messagesList">
                        <div class="loading">
                            <div class="loading-spinner"></div>
                            Loading messages...
                        </div>
                    </div>

                    <!-- Message View -->
                    <div id="messageView" class="message-view">
                        <!-- Message content will be displayed here -->
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <!-- Footer will be auto-injected by footer.js -->

    <!-- Compose Modal -->
    <div id="composeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Compose New Message</h3>
            </div>
            <form id="composeForm">
                <div class="form-group">
                    <label class="form-label" for="recipient">To <span style="color: var(--color-danger);">*</span></label>
                    <div id="recipientField">
                        <!-- Dynamic recipient field will be inserted here -->
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label" for="subject">Subject <span style="color: var(--color-danger);">*</span></label>
                    <input type="text" id="subject" class="form-control" placeholder="Enter message subject..." required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="message">Message <span style="color: var(--color-danger);">*</span></label>
                    <textarea id="message" class="form-control" placeholder="Type your message here..." required rows="8"></textarea>
                </div>
            </form>
            <div class="modal-footer">
                <button onclick="closeModal()" class="btn btn-secondary">Cancel</button>
                <button onclick="sendNewMessage()" class="btn btn-primary" id="sendMessageBtn">
                    Send Message
                </button>
            </div>
        </div>
    </div>

    <!-- Reply Modal -->
    <div id="replyModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Reply to Message</h3>
            </div>
            <form id="replyForm">
                <div class="form-group">
                    <label class="form-label">To: <strong id="replyTo"></strong></label>
                </div>
                <div class="form-group">
                    <label class="form-label">Subject: <strong id="replySubject"></strong></label>
                </div>
                <div class="message-thread">
                    <div class="message-thread-header">
                        <span class="message-thread-title">Previous message</span>
                        <span class="message-thread-date" id="originalDate"></span>
                    </div>
                    <div class="message-thread-content" id="quotedMessage"></div>
                </div>
                <div class="form-group">
                    <label class="form-label" for="replyMessage">Your Reply <span style="color: var(--color-danger);">*</span></label>
                    <textarea id="replyMessage" class="form-control" placeholder="Type your reply..." required rows="6"></textarea>
                </div>
            </form>
            <div class="modal-footer">
                <button onclick="closeModal()" class="btn btn-secondary">Cancel</button>
                <button onclick="sendReply()" class="btn btn-primary" id="sendReplyBtn">
                    Send Reply
                </button>
            </div>
        </div>
    </div>

    <!-- Load Supabase from CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Load config and Supabase client -->
    <script src="/js/config.js"></script>
    <script src="/js/supabase-client.js"></script>
    
    <!-- Load header and footer components -->
    <script src="/js/components/header.js"></script>
    <script src="/js/components/footer.js"></script>
    
    <!-- Page-specific JavaScript -->
    <script>
        // Page state
        let currentUser = null;
        let allMessages = [];
        let currentFolder = 'inbox';
        let currentMessage = null;
        let replyToMessage = null;
        let selectedRecipient = null;
        let searchTimeout = null;

        // Initialize page
        async function initializePage() {
            try {
                // Wait for Supabase
                await waitForSupabase();

                // Check authentication
                const session = await window.covetalks.checkAuth();
                if (!session) {
                    window.location.href = '/login.html';
                    return;
                }

                // Get user profile
                currentUser = await window.covetalks.getMemberProfile(session.user.id);

                // Load messages
                await loadMessages();

                // Update unread count
                await updateUnreadCount();
                
                // Check URL params for compose
                checkUrlParams();

            } catch (error) {
                console.error('Initialization error:', error);
            }
        }

        // Wait for Supabase client
        function waitForSupabase() {
            return new Promise((resolve) => {
                let attempts = 0;
                const maxAttempts = 20;
                
                function check() {
                    attempts++;
                    if (typeof window.covetalks !== 'undefined' && window.covetalks.supabase) {
                        resolve();
                    } else if (attempts < maxAttempts) {
                        setTimeout(check, 250);
                    } else {
                        console.error('Failed to initialize Supabase client');
                        window.location.href = '/login.html';
                    }
                }
                check();
            });
        }

        // Check URL parameters for compose
        function checkUrlParams() {
            const urlParams = new URLSearchParams(window.location.search);
            const compose = urlParams.get('compose');
            const recipientId = urlParams.get('to');
            const recipientName = urlParams.get('name');
            const subject = urlParams.get('subject');
            const opportunityId = urlParams.get('opportunity');
            
            if (compose === 'true') {
                // Pre-fill recipient if provided
                if (recipientId) {
                    selectedRecipient = {
                        id: recipientId,
                        name: decodeURIComponent(recipientName || 'User')
                    };
                }
                
                // Show compose modal after page loads
                setTimeout(() => {
                    showComposeModal();
                    
                    // Pre-fill subject if provided
                    if (subject) {
                        document.getElementById('subject').value = decodeURIComponent(subject);
                    }
                    
                    // Store opportunity ID if provided
                    if (opportunityId) {
                        document.getElementById('composeForm').dataset.opportunityId = opportunityId;
                    }
                }, 500);
            }
        }

        // Load messages
        async function loadMessages() {
            try {
                // Get both inbox and sent messages
                const [inbox, sent] = await Promise.all([
                    window.covetalks.getMessages('inbox'),
                    window.covetalks.getMessages('sent')
                ]);

                allMessages = [...inbox, ...sent];
                
                // Update counts
                const inboxUnread = inbox.filter(m => m.status === 'unread').length;
                const archived = allMessages.filter(m => m.status === 'archived').length;
                
                // Update header stats
                document.getElementById('totalMessages').textContent = allMessages.length;
                document.getElementById('unreadMessages').textContent = inboxUnread;
                document.getElementById('sentMessages').textContent = sent.length;
                
                // Update sidebar
                const inboxCountElement = document.getElementById('inboxCount');
                if (inboxUnread > 0) {
                    inboxCountElement.textContent = inboxUnread;
                    inboxCountElement.classList.remove('hidden');
                } else {
                    inboxCountElement.classList.add('hidden');
                }
                
                // Display messages
                displayMessages();

            } catch (error) {
                console.error('Error loading messages:', error);
            }
        }

        // Display messages
        function displayMessages() {
            const container = document.getElementById('messagesList');
            
            // Filter messages based on current folder
            let messages = [];
            if (currentFolder === 'inbox') {
                messages = allMessages.filter(m => m.recipient_id === currentUser.id && m.status !== 'archived');
            } else if (currentFolder === 'sent') {
                messages = allMessages.filter(m => m.sender_id === currentUser.id);
            } else if (currentFolder === 'archived') {
                messages = allMessages.filter(m => m.status === 'archived');
            }

            if (messages.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üì≠</div>
                        <h3>No messages</h3>
                        <p>Your ${currentFolder} is empty</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = messages.map(msg => {
                const isUnread = msg.status === 'unread' && msg.recipient_id === currentUser.id;
                const isSent = msg.sender_id === currentUser.id;
                const otherPerson = isSent ? msg.recipient : msg.sender;
                const initials = otherPerson?.name ? 
                    otherPerson.name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2) : 
                    '??';

                return `
                    <div class="message-item ${isUnread ? 'unread' : ''}" onclick="viewMessage('${msg.id}')">
                        <div class="message-avatar">${initials}</div>
                        <div class="message-content">
                            <div class="message-header">
                                <div>
                                    <div class="message-sender ${isUnread ? 'unread' : ''}">
                                        ${isSent ? 'To: ' : ''}${otherPerson?.name || 'Unknown'}
                                    </div>
                                    <div class="message-subject">${msg.subject}</div>
                                </div>
                                <div class="message-time">${formatTimeAgo(msg.created_at)}</div>
                            </div>
                            <div class="message-preview">
                                ${msg.message.substring(0, 100)}${msg.message.length > 100 ? '...' : ''}
                            </div>
                            ${msg.opportunity ? `
                                <div class="message-meta">
                                    <span class="message-tag">üìå ${msg.opportunity.title}</span>
                                </div>
                            ` : ''}
                        </div>
                        ${!isSent ? `
                            <div class="message-actions-quick">
                                <button class="quick-action-btn" onclick="event.stopPropagation(); quickReply('${msg.id}')">
                                    Quick Reply
                                </button>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        // Quick reply
        function quickReply(messageId) {
            const message = allMessages.find(m => m.id === messageId);
            if (message) {
                showReplyModal(messageId);
            }
        }

        // View message
        async function viewMessage(messageId) {
            const message = allMessages.find(m => m.id === messageId);
            if (!message) return;

            currentMessage = message;

            // Mark as read if unread
            if (message.status === 'unread' && message.recipient_id === currentUser.id) {
                await window.covetalks.markMessageAsRead(messageId);
                message.status = 'read';
                await updateUnreadCount();
                displayMessages();
            }

            // Hide list, show message view
            document.getElementById('messagesList').style.display = 'none';
            const messageView = document.getElementById('messageView');
            messageView.classList.add('active');

            const isSent = message.sender_id === currentUser.id;
            const isReceived = message.recipient_id === currentUser.id;
            const otherPerson = isSent ? message.recipient : message.sender;

            messageView.innerHTML = `
                <div class="message-view-header">
                    <button onclick="backToList()" class="btn btn-secondary btn-sm mb-3">
                        ‚Üê Back to Messages
                    </button>
                    <h2 class="message-view-subject">${message.subject}</h2>
                    <div class="message-view-meta">
                        <span><strong>${isSent ? 'To' : 'From'}:</strong> ${otherPerson?.name || 'Unknown'}</span>
                        <span><strong>Date:</strong> ${formatDateTime(message.created_at)}</span>
                        ${message.opportunity ? `
                            <span><strong>Related:</strong> ${message.opportunity.title}</span>
                        ` : ''}
                    </div>
                </div>
                <div class="message-view-body">${message.message}</div>
                <div class="message-actions">
                    ${isReceived ? `
                        <button onclick="showReplyModal('${message.id}')" class="btn btn-primary">
                            Reply
                        </button>
                    ` : ''}
                    ${message.status !== 'archived' ? `
                        <button onclick="archiveMessage('${message.id}')" class="btn btn-secondary">
                            Archive
                        </button>
                    ` : ''}
                </div>
            `;
        }

        // Back to list
        function backToList() {
            document.getElementById('messagesList').style.display = 'block';
            document.getElementById('messageView').classList.remove('active');
        }

        // Show compose modal
        function showComposeModal(recipientId = null, recipientName = null) {
            const modal = document.getElementById('composeModal');
            modal.classList.add('show');
            
            // Reset form
            document.getElementById('composeForm').reset();
            
            // Set recipient if provided
            if (recipientId && recipientName) {
                selectedRecipient = { id: recipientId, name: recipientName };
            }
            
            // Update recipient field
            if (selectedRecipient) {
                const recipientField = document.getElementById('recipientField');
                recipientField.innerHTML = `
                    <div class="selected-recipient">
                        <span class="recipient-tag">
                            ${selectedRecipient.name}
                            <button onclick="clearRecipient()" class="remove-btn">√ó</button>
                        </span>
                        <input type="hidden" id="recipientId" value="${selectedRecipient.id}">
                    </div>
                `;
            } else {
                setupRecipientSearch();
            }
        }

        // Setup recipient search
        function setupRecipientSearch() {
            const recipientField = document.getElementById('recipientField');
            recipientField.innerHTML = `
                <div class="recipient-search-container">
                    <span class="search-input-icon">üîç</span>
                    <input type="text" 
                           id="recipientSearch" 
                           placeholder="Start typing to search for members..." 
                           onkeyup="handleRecipientSearch(this.value)"
                           autocomplete="off">
                    <div id="recipientSuggestions" class="recipient-suggestions hidden"></div>
                </div>
                <input type="hidden" id="recipientId" value="">
            `;
            
            // Focus on the search field
            setTimeout(() => {
                document.getElementById('recipientSearch')?.focus();
            }, 100);
        }

        // Handle recipient search
        function handleRecipientSearch(query) {
            clearTimeout(searchTimeout);
            
            const suggestions = document.getElementById('recipientSuggestions');
            
            if (!query || query.length < 2) {
                suggestions.classList.add('hidden');
                return;
            }
            
            // Show searching indicator
            suggestions.innerHTML = `
                <div class="searching-indicator">
                    <span class="loading-spinner"></span>
                    Searching...
                </div>
            `;
            suggestions.classList.remove('hidden');
            
            // Debounce search
            searchTimeout = setTimeout(() => {
                searchRecipients(query);
            }, 300);
        }

        // Search for recipients
        async function searchRecipients(query) {
            try {
                // Search members in database
                const { data: members, error } = await window.covetalks.supabase
                    .from('members')
                    .select('id, name, email, member_type')
                    .or(`name.ilike.%${query}%,email.ilike.%${query}%`)
                    .neq('id', currentUser.id)
                    .limit(10);
                
                if (error) throw error;
                
                const suggestions = document.getElementById('recipientSuggestions');
                
                if (members && members.length > 0) {
                    suggestions.innerHTML = members.map(member => {
                        const initials = member.name ? 
                            member.name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2) : 
                            '??';
                        const badgeClass = member.member_type === 'Speaker' ? 'speaker' : 'organization';
                        
                        return `
                            <div class="suggestion-item" onclick="selectRecipient('${member.id}', '${member.name}', '${member.email}')">
                                <div class="suggestion-avatar">${initials}</div>
                                <div class="suggestion-info">
                                    <div class="suggestion-name">${member.name || 'Unknown'}</div>
                                    <div class="suggestion-email">${member.email}</div>
                                </div>
                                <span class="member-type-badge ${badgeClass}">${member.member_type}</span>
                            </div>
                        `;
                    }).join('');
                } else {
                    suggestions.innerHTML = `
                        <div class="no-results">
                            <p>No members found matching "${query}"</p>
                            <small>Try searching by name or email</small>
                        </div>
                    `;
                }
                
                suggestions.classList.remove('hidden');
            } catch (error) {
                console.error('Error searching recipients:', error);
                const suggestions = document.getElementById('recipientSuggestions');
                suggestions.innerHTML = '<div class="no-results">Error searching members. Please try again.</div>';
            }
        }

        // Select a recipient
        function selectRecipient(id, name, email) {
            selectedRecipient = { id, name, email };
            
            const recipientField = document.getElementById('recipientField');
            recipientField.innerHTML = `
                <div class="selected-recipient">
                    <span class="recipient-tag">
                        ${name}
                        <button onclick="clearRecipient()" class="remove-btn">√ó</button>
                    </span>
                    <input type="hidden" id="recipientId" value="${id}">
                </div>
            `;
            
            // Focus on subject field
            document.getElementById('subject').focus();
        }

        // Clear selected recipient
        function clearRecipient() {
            selectedRecipient = null;
            setupRecipientSearch();
        }

        // Send new message
        async function sendNewMessage() {
            const recipientId = selectedRecipient?.id || document.getElementById('recipientId')?.value;
            const subject = document.getElementById('subject').value.trim();
            const message = document.getElementById('message').value.trim();
            const opportunityId = document.getElementById('composeForm').dataset.opportunityId || null;
            
            // Validation
            if (!recipientId) {
                showNotification('Please select a recipient', 'error');
                return;
            }
            
            if (!subject) {
                showNotification('Please enter a subject', 'error');
                return;
            }
            
            if (!message) {
                showNotification('Please enter a message', 'error');
                return;
            }
            
            // Show loading state
            const sendBtn = document.getElementById('sendMessageBtn');
            const originalText = sendBtn.textContent;
            sendBtn.textContent = 'Sending...';
            sendBtn.disabled = true;
            
            try {
                // Send the message
                await window.covetalks.sendMessage(
                    recipientId,
                    subject,
                    message,
                    opportunityId
                );
                
                // Close modal and reset
                closeModal();
                document.getElementById('composeForm').reset();
                selectedRecipient = null;
                
                // Reload messages
                await loadMessages();
                
                // Show success message
                showNotification('Message sent successfully!', 'success');
                
            } catch (error) {
                console.error('Error sending message:', error);
                showNotification('Failed to send message. Please try again.', 'error');
            } finally {
                sendBtn.textContent = originalText;
                sendBtn.disabled = false;
            }
        }

        // Show reply modal
        function showReplyModal(messageId) {
            const message = allMessages.find(m => m.id === messageId);
            if (!message) return;
            
            replyToMessage = message;
            document.getElementById('replyTo').textContent = message.sender?.name || 'Unknown';
            document.getElementById('replySubject').textContent = `Re: ${message.subject}`;
            document.getElementById('originalDate').textContent = formatDateTime(message.created_at);
            
            // Show original message in thread
            const quotedContent = message.message.length > 500 ? 
                message.message.substring(0, 500) + '...' : 
                message.message;
            document.getElementById('quotedMessage').textContent = quotedContent;
            
            // Clear reply textarea
            document.getElementById('replyMessage').value = '';
            
            document.getElementById('replyModal').classList.add('show');
            
            // Focus on reply textarea
            setTimeout(() => {
                document.getElementById('replyMessage').focus();
            }, 100);
        }

        // Send reply
        async function sendReply() {
            if (!replyToMessage) return;
            
            const messageContent = document.getElementById('replyMessage').value.trim();
            
            if (!messageContent) {
                showNotification('Please enter a reply message', 'error');
                return;
            }
            
            const sendBtn = document.getElementById('sendReplyBtn');
            const originalText = sendBtn.textContent;
            sendBtn.textContent = 'Sending...';
            sendBtn.disabled = true;
            
            try {
                await window.covetalks.sendMessage(
                    replyToMessage.sender_id,
                    `Re: ${replyToMessage.subject}`,
                    messageContent,
                    replyToMessage.opportunity_id
                );
                
                closeModal();
                await loadMessages();
                showNotification('Reply sent successfully!', 'success');
                
            } catch (error) {
                console.error('Error sending reply:', error);
                showNotification('Failed to send reply', 'error');
            } finally {
                sendBtn.textContent = originalText;
                sendBtn.disabled = false;
            }
        }

        // Filter messages
        function filterMessages(folder) {
            currentFolder = folder;
            
            // Update menu
            document.querySelectorAll('.inbox-menu a').forEach(a => a.classList.remove('active'));
            event.target.closest('a').classList.add('active');
            
            // Update title
            const titles = {
                'inbox': 'Inbox',
                'sent': 'Sent Messages',
                'archived': 'Archived Messages'
            };
            document.getElementById('folderTitle').textContent = titles[folder] || 'Messages';
            
            // Display filtered messages
            displayMessages();
            backToList();
        }

        // Search messages
        function searchMessages() {
            const search = document.getElementById('searchMessages').value.toLowerCase();
            
            if (!search) {
                displayMessages();
                return;
            }
            
            // Filter and display
            const container = document.getElementById('messagesList');
            const filtered = allMessages.filter(msg => 
                msg.subject.toLowerCase().includes(search) ||
                msg.message.toLowerCase().includes(search) ||
                msg.sender?.name?.toLowerCase().includes(search) ||
                msg.recipient?.name?.toLowerCase().includes(search)
            );
            
            if (filtered.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üîç</div>
                        <h3>No results found</h3>
                        <p>Try a different search term</p>
                    </div>
                `;
            } else {
                // Display filtered results
                displayMessages();
            }
        }

        // Archive message
        async function archiveMessage(messageId) {
            try {
                await window.covetalks.supabase
                    .from('messages')
                    .update({ status: 'archived' })
                    .eq('id', messageId);
                
                await loadMessages();
                backToList();
                showNotification('Message archived', 'info');
                
            } catch (error) {
                console.error('Error archiving message:', error);
                showNotification('Failed to archive message', 'error');
            }
        }

        // Update unread count
        async function updateUnreadCount() {
            const count = await window.covetalks.getUnreadMessageCount();
            
            // Update badge in header if it exists
            const headerBadge = document.getElementById('inboxBadge');
            if (headerBadge) {
                if (count > 0) {
                    headerBadge.textContent = count > 99 ? '99+' : count;
                    headerBadge.classList.remove('hidden');
                } else {
                    headerBadge.classList.add('hidden');
                }
            }
        }

        // Show notification
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.innerHTML = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }

        // Close modal
        function closeModal() {
            document.getElementById('composeModal').classList.remove('show');
            document.getElementById('replyModal').classList.remove('show');
            
            // Clear URL parameters
            const url = new URL(window.location);
            url.searchParams.delete('compose');
            url.searchParams.delete('to');
            url.searchParams.delete('name');
            url.searchParams.delete('subject');
            url.searchParams.delete('opportunity');
            window.history.replaceState({}, document.title, url.pathname);
        }

        // Format time ago
        function formatTimeAgo(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            if (diffDays < 7) return `${diffDays}d ago`;
            return date.toLocaleDateString();
        }

        // Format date time
        function formatDateTime(dateString) {
            return new Date(dateString).toLocaleString('en-US', {
                month: 'short',
                day: 'numeric',
                year: 'numeric',
                hour: 'numeric',
                minute: '2-digit',
                hour12: true
            });
        }

        // Close modals when clicking outside
        document.addEventListener('click', function(event) {
            if (event.target.classList.contains('modal')) {
                closeModal();
            }
        });

        // Initialize on load
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializePage);
        } else {
            initializePage();
        }
    </script>
</body>
</html>