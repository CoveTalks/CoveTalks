<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inbox - CoveTalks</title>
    <link rel="icon" type="image/svg+xml" href="/Images/CoveTalks_Vertical.svg">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: #f8f9fa;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* Header Styles */
        header {
            background: white;
            color: #333;
            padding: 1rem 0;
            position: fixed;
            width: 100%;
            top: 0;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: inline-flex;
            align-items: center;
            text-decoration: none;
        }
        
        .logo-img {
            height: 70px;
            width: auto;
            display: block;
        }

        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .nav-links {
            display: flex;
            list-style: none;
            gap: 2rem;
        }

        .nav-links a {
            color: #333;
            text-decoration: none;
            font-weight: 500;
            transition: color 0.3s;
        }

        .nav-links a:hover {
            color: #155588;
        }

        .nav-links a.active {
            color: #155588;
            border-bottom: 2px solid #155588;
            padding-bottom: 2px;
        }

        .nav-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            transition: all 0.3s;
            font-weight: 500;
            text-align: center;
        }

        .btn-primary {
            background: #155588;
            color: white;
        }

        .btn-primary:hover {
            background: #1e3d6f;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: transparent;
            color: #155588;
            border: 2px solid #155588;
        }

        .btn-secondary:hover {
            background: #155588;
            color: white;
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-success:hover {
            background: #229954;
        }

        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.85rem;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        /* User Menu */
        .user-menu {
            position: relative;
        }

        .user-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #1e93b7);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            cursor: pointer;
            font-size: 1.1rem;
            transition: transform 0.2s;
            position: relative;
        }

        .user-avatar:hover {
            transform: scale(1.05);
        }

        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #dc3545;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: bold;
        }

        .dropdown-menu {
            position: absolute;
            top: calc(100% + 10px);
            right: 0;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            min-width: 200px;
            display: none;
            z-index: 1000;
            overflow: hidden;
        }

        .dropdown-menu.show {
            display: block;
        }

        .dropdown-menu a {
            display: block;
            padding: 0.75rem 1.25rem;
            color: #333;
            text-decoration: none;
            transition: background 0.2s;
        }

        .dropdown-menu a:hover {
            background: #f8f9fa;
        }

        .dropdown-divider {
            height: 1px;
            background: #e1e8ed;
            margin: 0;
        }

        /* Main Content */
        .main-content {
            padding-top: 6rem;
            padding-bottom: 3rem;
            min-height: 100vh;
        }

        /* Page Header */
        .page-header {
            background: linear-gradient(135deg, #667eea 0%, #1e93b7 100%);
            color: white;
            padding: 2rem;
            margin: 2rem 0;
            border-radius: 15px;
        }

        .page-header h1 {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .inbox-stats {
            display: flex;
            gap: 2rem;
            margin-top: 1rem;
        }

        .inbox-stat {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: rgba(255, 255, 255, 0.2);
            padding: 0.5rem 1rem;
            border-radius: 20px;
        }

        /* Inbox Layout */
        .inbox-container {
            display: grid;
            grid-template-columns: 250px 1fr;
            gap: 2rem;
        }

        /* Sidebar */
        .inbox-sidebar {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            height: fit-content;
            position: sticky;
            top: 100px;
        }

        .inbox-menu {
            list-style: none;
        }

        .inbox-menu li {
            margin-bottom: 0.5rem;
        }

        .inbox-menu a {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem 1rem;
            color: #333;
            text-decoration: none;
            border-radius: 10px;
            transition: all 0.3s;
        }

        .inbox-menu a:hover {
            background: #f8f9fa;
        }

        .inbox-menu a.active {
            background: #e8f4fd;
            color: #155588;
            font-weight: 600;
        }

        .menu-count {
            background: #dc3545;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 10px;
            font-size: 0.75rem;
            font-weight: 600;
            min-width: 20px;
            text-align: center;
        }

        /* Messages List */
        .messages-container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            overflow: hidden;
        }

        .messages-header {
            padding: 1.5rem;
            border-bottom: 2px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .messages-header h2 {
            color: #155588;
        }

        .search-box {
            position: relative;
            width: 300px;
        }

        .search-box input {
            width: 100%;
            padding: 0.5rem 1rem 0.5rem 2.5rem;
            border: 2px solid #e1e8ed;
            border-radius: 20px;
            font-size: 0.9rem;
        }

        .search-box input:focus {
            outline: none;
            border-color: #155588;
        }

        .search-icon {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: #999;
        }

        /* Message Item */
        .message-item {
            padding: 1.5rem;
            border-bottom: 1px solid #f0f0f0;
            transition: background 0.2s;
            cursor: pointer;
            display: flex;
            gap: 1rem;
            position: relative;
        }

        .message-item:hover {
            background: #f8f9fa;
        }

        .message-item:hover .message-actions-quick {
            opacity: 1;
        }

        .message-item.unread {
            background: #f0f8ff;
            border-left: 4px solid #155588;
        }

        .message-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #1e93b7);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            flex-shrink: 0;
        }

        .message-content {
            flex: 1;
            min-width: 0;
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 0.5rem;
        }

        .message-sender {
            font-weight: 600;
            color: #333;
        }

        .message-sender.unread {
            color: #155588;
        }

        .message-time {
            font-size: 0.85rem;
            color: #999;
            white-space: nowrap;
        }

        .message-subject {
            font-weight: 500;
            color: #555;
            margin-bottom: 0.25rem;
        }

        .message-preview {
            color: #666;
            font-size: 0.9rem;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .message-meta {
            display: flex;
            gap: 1rem;
            margin-top: 0.5rem;
            font-size: 0.85rem;
            color: #999;
        }

        .message-tag {
            background: #e8f4fd;
            color: #155588;
            padding: 0.25rem 0.5rem;
            border-radius: 10px;
            font-size: 0.75rem;
        }

        /* Quick Actions on Hover */
        .message-actions-quick {
            position: absolute;
            right: 1rem;
            bottom: 1rem;
            display: flex;
            gap: 0.5rem;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .quick-action-btn {
            padding: 0.4rem 0.8rem;
            background: white;
            border: 1px solid #e1e8ed;
            border-radius: 15px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .quick-action-btn:hover {
            background: #155588;
            color: white;
            border-color: #155588;
        }

        /* Message View */
        .message-view {
            padding: 2rem;
            display: none;
        }

        .message-view.active {
            display: block;
        }

        .message-view-header {
            margin-bottom: 2rem;
        }

        .message-view-subject {
            font-size: 1.5rem;
            color: #155588;
            margin-bottom: 1rem;
        }

        .message-view-meta {
            display: flex;
            gap: 2rem;
            color: #666;
            font-size: 0.9rem;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 10px;
            margin-bottom: 1.5rem;
        }

        .message-view-body {
            background: white;
            padding: 2rem;
            border: 2px solid #f0f0f0;
            border-radius: 10px;
            line-height: 1.8;
            white-space: pre-wrap;
            margin-bottom: 2rem;
            min-height: 200px;
        }

        .message-actions {
            display: flex;
            gap: 1rem;
            padding: 1rem 0;
        }

        /* Recipient Autocomplete Styles */
        #recipientField {
            position: relative;
        }

        .recipient-search-container {
            position: relative;
        }

        #recipientSearch {
            width: 100%;
            padding: 0.75rem;
            padding-left: 2.5rem;
            border: 2px solid #e1e8ed;
            border-radius: 5px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        #recipientSearch:focus {
            outline: none;
            border-color: #155588;
            box-shadow: 0 0 0 3px rgba(21, 85, 136, 0.1);
        }

        .search-input-icon {
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: #999;
            font-size: 1.1rem;
        }

        .selected-recipient {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            background: #f8f9fa;
            border-radius: 5px;
        }

        .recipient-tag {
            background: #e8f4fd;
            color: #155588;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 500;
        }

        .remove-btn {
            background: none;
            border: none;
            color: #155588;
            font-size: 1.2rem;
            cursor: pointer;
            padding: 0;
            margin-left: 0.5rem;
            line-height: 1;
            transition: color 0.2s;
        }

        .remove-btn:hover {
            color: #dc3545;
        }

        .recipient-suggestions {
            position: absolute;
            top: calc(100% + 5px);
            left: 0;
            right: 0;
            background: white;
            border: 2px solid #e1e8ed;
            border-radius: 5px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 100;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }

        .suggestion-item {
            padding: 1rem;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .suggestion-item:hover {
            background: #f8f9fa;
        }

        .suggestion-item:last-child {
            border-bottom: none;
        }

        .suggestion-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #1e93b7);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.9rem;
        }

        .suggestion-info {
            flex: 1;
        }

        .suggestion-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 0.25rem;
        }

        .suggestion-email {
            font-size: 0.85rem;
            color: #666;
        }

        .member-type-badge {
            background: #f0f0f0;
            padding: 0.25rem 0.5rem;
            border-radius: 10px;
            font-size: 0.75rem;
            color: #666;
            white-space: nowrap;
        }

        .member-type-badge.speaker {
            background: #e8f4fd;
            color: #155588;
        }

        .member-type-badge.organization {
            background: #fff4e6;
            color: #f2b236;
        }

        .no-results {
            padding: 2rem;
            text-align: center;
            color: #999;
        }

        .searching-indicator {
            padding: 1rem;
            text-align: center;
            color: #666;
        }

        .searching-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #155588;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 0.5rem;
        }

        /* Reply Thread Styles */
        .message-thread {
            background: #f8f9fa;
            padding: 1rem;
            border-left: 3px solid #155588;
            margin-bottom: 1rem;
            border-radius: 5px;
        }

        .message-thread-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .message-thread-title {
            font-size: 0.85rem;
            color: #666;
            font-weight: 600;
        }

        .message-thread-date {
            font-size: 0.8rem;
            color: #999;
        }

        .message-thread-content {
            color: #555;
            font-size: 0.9rem;
            line-height: 1.5;
            max-height: 150px;
            overflow-y: auto;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: #666;
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        /* Loading */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 3rem;
            color: #666;
        }

        .loading-spinner {
            display: inline-block;
            width: 30px;
            height: 30px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #155588;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            max-width: 600px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
            animation: slideUp 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from {
                transform: translateY(50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #f0f0f0;
        }

        .modal-header h3 {
            color: #155588;
            font-size: 1.5rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            color: #555;
            margin-bottom: 0.5rem;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e1e8ed;
            border-radius: 5px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #155588;
            box-shadow: 0 0 0 3px rgba(21, 85, 136, 0.1);
        }

        .form-group textarea {
            min-height: 200px;
            resize: vertical;
            font-family: inherit;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #f0f0f0;
            margin-top: 1.5rem;
        }

        /* Notification Toast */
        .notification {
            position: fixed;
            top: 100px;
            right: 20px;
            padding: 1rem 1.5rem;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            z-index: 3000;
            animation: slideInRight 0.3s ease;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .notification-success {
            background: #27ae60;
            color: white;
        }

        .notification-error {
            background: #dc3545;
            color: white;
        }

        .notification-info {
            background: #155588;
            color: white;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        .hidden {
            display: none !important;
        }

        /* Responsive */
        @media (max-width: 992px) {
            .inbox-container {
                grid-template-columns: 1fr;
            }

            .inbox-sidebar {
                position: static;
                margin-bottom: 2rem;
            }
        }

        @media (max-width: 768px) {
            .nav-links {
                display: none;
            }

            .messages-header {
                flex-direction: column;
                gap: 1rem;
            }

            .search-box {
                width: 100%;
            }

            .message-view-meta {
                flex-direction: column;
                gap: 0.5rem;
            }

            .message-actions-quick {
                opacity: 1;
                position: static;
                margin-top: 0.5rem;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header>
        <div class="nav-container">
            <nav>
                <a href="index.html" class="logo">
                    <img src="Images/CoveTalks_logo.svg" alt="CoveTalks" class="logo-img" onerror="this.style.display='none'">
                </a>
                
                <ul class="nav-links" id="navLinks">
                    <li><a href="dashboard.html">Dashboard</a></li>
                    <li><a href="members.html">Find Speakers</a></li>
                    <li><a href="opportunities.html">Opportunities</a></li>
                    <li><a href="bookings.html">My Bookings</a></li>
                    <li><a href="profile.html">Profile</a></li>
                </ul>
    
                <div class="nav-right">
                    <div class="user-menu" id="userMenu">
                        <div class="user-avatar" id="userAvatar" onclick="toggleDropdown()">
                            U
                            <span class="notification-badge hidden" id="unreadBadge">0</span>
                        </div>
                        <div class="dropdown-menu" id="dropdownMenu">
                            <a href="inbox.html" class="active">
                                Inbox
                                <span id="dropdownUnread" class="menu-count hidden">0</span>
                            </a>
                            <div class="dropdown-divider"></div>
                            <a href="settings.html">Settings</a>
                            <a href="billing.html">Billing</a>
                            <div class="dropdown-divider"></div>
                            <a href="#" onclick="logout(); return false;">Logout</a>
                        </div>
                    </div>
                </div>
            </nav>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <div class="container">
            <!-- Page Header -->
            <div class="page-header">
                <h1>Inbox</h1>
                <div class="inbox-stats">
                    <div class="inbox-stat">
                        <span>Total:</span>
                        <strong id="totalMessages">0</strong>
                    </div>
                    <div class="inbox-stat">
                        <span>Unread:</span>
                        <strong id="unreadMessages">0</strong>
                    </div>
                    <div class="inbox-stat">
                        <span>Sent:</span>
                        <strong id="sentMessages">0</strong>
                    </div>
                </div>
            </div>

            <!-- Inbox Container -->
            <div class="inbox-container">
                <!-- Sidebar -->
                <div class="inbox-sidebar">
                    <button onclick="showComposeModal()" class="btn btn-primary" style="width: 100%; margin-bottom: 1.5rem;">
                        Compose
                    </button>
                    <ul class="inbox-menu">
                        <li>
                            <a href="#" class="active" onclick="filterMessages('inbox'); return false;">
                                <span>Inbox</span>
                                <span class="menu-count hidden" id="inboxCount">0</span>
                            </a>
                        </li>
                        <li>
                            <a href="#" onclick="filterMessages('sent'); return false;">
                                <span>Sent</span>
                            </a>
                        </li>
                        <li>
                            <a href="#" onclick="filterMessages('archived'); return false;">
                                <span>Archived</span>
                            </a>
                        </li>
                    </ul>
                </div>

                <!-- Messages Container -->
                <div class="messages-container">
                    <!-- Messages Header -->
                    <div class="messages-header">
                        <h2 id="folderTitle">Inbox</h2>
                        <div class="search-box">
                            <span class="search-icon"></span>
                            <input type="text" id="searchMessages" placeholder="Search messages..." onkeyup="searchMessages()">
                        </div>
                    </div>

                    <!-- Messages List -->
                    <div id="messagesList">
                        <div class="loading">
                            <div class="loading-spinner"></div>
                            Loading messages...
                        </div>
                    </div>

                    <!-- Message View -->
                    <div id="messageView" class="message-view">
                        <!-- Message content will be displayed here -->
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Compose Modal -->
    <div id="composeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>✉️ Compose New Message</h3>
            </div>
            <form id="composeForm">
                <div class="form-group">
                    <label for="recipient">To <span style="color: #dc3545;">*</span></label>
                    <div id="recipientField">
                        <!-- Dynamic recipient field will be inserted here -->
                    </div>
                </div>
                <div class="form-group">
                    <label for="subject">Subject <span style="color: #dc3545;">*</span></label>
                    <input type="text" id="subject" placeholder="Enter message subject..." required>
                </div>
                <div class="form-group">
                    <label for="message">Message <span style="color: #dc3545;">*</span></label>
                    <textarea id="message" placeholder="Type your message here..." required></textarea>
                </div>
            </form>
            <div class="modal-footer">
                <button onclick="closeModal()" class="btn btn-secondary">Cancel</button>
                <button onclick="sendNewMessage()" class="btn btn-primary" id="sendMessageBtn">
                    Send Message
                </button>
            </div>
        </div>
    </div>

    <!-- Reply Modal -->
    <div id="replyModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>↩️ Reply to Message</h3>
            </div>
            <form id="replyForm">
                <div class="form-group">
                    <label>To: <strong id="replyTo"></strong></label>
                </div>
                <div class="form-group">
                    <label>Subject: <strong id="replySubject"></strong></label>
                </div>
                <div class="message-thread">
                    <div class="message-thread-header">
                        <span class="message-thread-title">Previous message</span>
                        <span class="message-thread-date" id="originalDate"></span>
                    </div>
                    <div class="message-thread-content" id="quotedMessage"></div>
                </div>
                <div class="form-group">
                    <label for="replyMessage">Your Reply <span style="color: #dc3545;">*</span></label>
                    <textarea id="replyMessage" placeholder="Type your reply..." required></textarea>
                </div>
            </form>
            <div class="modal-footer">
                <button onclick="closeModal()" class="btn btn-secondary">Cancel</button>
                <button onclick="sendReply()" class="btn btn-primary" id="sendReplyBtn">
                    Send Reply
                </button>
            </div>
        </div>
    </div>

    <!-- Load Supabase from CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Load config and Supabase client -->
    <script src="js/config.js"></script>
    <script src="js/supabase-client.js"></script>
    
    <script>
        // Page state
        let currentUser = null;
        let allMessages = [];
        let currentFolder = 'inbox';
        let currentMessage = null;
        let replyToMessage = null;
        let selectedRecipient = null;
        let searchTimeout = null;

        // Initialize page
        async function initializePage() {
            await waitForSupabase(async () => {
                try {
                    // Check authentication
                    const session = await window.covetalks.checkAuth();
                    if (!session) {
                        window.location.href = '/login.html';
                        return;
                    }

                    // Get user profile
                    currentUser = await window.covetalks.getMemberProfile(session.user.id);
                    updateNavigation(currentUser);

                    // Load messages
                    await loadMessages();

                    // Update unread count
                    await updateUnreadCount();
                    
                    // Check URL params for compose
                    checkUrlParams();

                } catch (error) {
                    console.error('Initialization error:', error);
                }
            });
        }

        // Wait for Supabase client
        function waitForSupabase(callback) {
            let attempts = 0;
            const maxAttempts = 10;
            
            function check() {
                attempts++;
                if (typeof window.covetalks !== 'undefined' && window.covetalks.supabase) {
                    callback();
                } else if (attempts < maxAttempts) {
                    setTimeout(check, 500);
                } else {
                    console.error('Failed to initialize Supabase client');
                    window.location.href = '/login.html';
                }
            }
            check();
        }

        // Check URL parameters for compose
        function checkUrlParams() {
            const urlParams = new URLSearchParams(window.location.search);
            const compose = urlParams.get('compose');
            const recipientId = urlParams.get('to');
            const recipientName = urlParams.get('name');
            const subject = urlParams.get('subject');
            const opportunityId = urlParams.get('opportunity');
            
            if (compose === 'true') {
                // Pre-fill recipient if provided
                if (recipientId) {
                    selectedRecipient = {
                        id: recipientId,
                        name: decodeURIComponent(recipientName || 'User')
                    };
                }
                
                // Show compose modal after page loads
                setTimeout(() => {
                    showComposeModal();
                    
                    // Pre-fill subject if provided
                    if (subject) {
                        document.getElementById('subject').value = decodeURIComponent(subject);
                    }
                    
                    // Store opportunity ID if provided
                    if (opportunityId) {
                        document.getElementById('composeForm').dataset.opportunityId = opportunityId;
                    }
                }, 500);
            }
        }

        // Update navigation
        function updateNavigation(user) {
            const navLinks = document.getElementById('navLinks');
            const userAvatar = document.getElementById('userAvatar');
            
            if (user) {
                const initials = user.name ? 
                    user.name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2) : 
                    'U';
                userAvatar.childNodes[0].textContent = initials;
                
                if (user.member_type === 'Organization') {
                    navLinks.innerHTML = `
                        <li><a href="organization-dashboard.html">Dashboard</a></li>
                        <li><a href="members.html">Find Speakers</a></li>
                        <li><a href="post-opportunity.html">Post Opportunity</a></li>
                        <li><a href="my-opportunities.html">My Opportunities</a></li>
                        <li><a href="saved-speakers.html">Saved Speakers</a></li>
                    `;
                } else {
                    navLinks.innerHTML = `
                        <li><a href="dashboard.html">Dashboard</a></li>
                        <li><a href="members.html">Find Speakers</a></li>
                        <li><a href="opportunities.html">Opportunities</a></li>
                        <li><a href="bookings.html">My Bookings</a></li>
                        <li><a href="profile.html">Profile</a></li>
                    `;
                }
            }
        }

        // Load messages
        async function loadMessages() {
            try {
                // Get both inbox and sent messages
                const [inbox, sent] = await Promise.all([
                    window.covetalks.getMessages('inbox'),
                    window.covetalks.getMessages('sent')
                ]);

                allMessages = [...inbox, ...sent];
                
                // Update counts
                const inboxUnread = inbox.filter(m => m.status === 'unread').length;
                const archived = allMessages.filter(m => m.status === 'archived').length;
                
                // Update header stats
                document.getElementById('totalMessages').textContent = allMessages.length;
                document.getElementById('unreadMessages').textContent = inboxUnread;
                document.getElementById('sentMessages').textContent = sent.length;
                
                // Update sidebar - Only show count for inbox if there are unread messages
                const inboxCountElement = document.getElementById('inboxCount');
                if (inboxUnread > 0) {
                    inboxCountElement.textContent = inboxUnread;
                    inboxCountElement.classList.remove('hidden');
                } else {
                    inboxCountElement.classList.add('hidden');
                }
                
                // No counts for sent and archived (removed the count display)

                // Display messages
                displayMessages();

            } catch (error) {
                console.error('Error loading messages:', error);
            }
        }

        // Display messages with quick reply buttons
        function displayMessages() {
            const container = document.getElementById('messagesList');
            
            // Filter messages based on current folder
            let messages = [];
            if (currentFolder === 'inbox') {
                messages = allMessages.filter(m => m.recipient_id === currentUser.id && m.status !== 'archived');
            } else if (currentFolder === 'sent') {
                messages = allMessages.filter(m => m.sender_id === currentUser.id);
            } else if (currentFolder === 'archived') {
                messages = allMessages.filter(m => m.status === 'archived');
            }

            if (messages.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">📭</div>
                        <h3>No messages</h3>
                        <p>Your ${currentFolder} is empty</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = messages.map(msg => {
                const isUnread = msg.status === 'unread' && msg.recipient_id === currentUser.id;
                const isSent = msg.sender_id === currentUser.id;
                const otherPerson = isSent ? msg.recipient : msg.sender;
                const initials = otherPerson?.name ? 
                    otherPerson.name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2) : 
                    '??';

                return `
                    <div class="message-item ${isUnread ? 'unread' : ''}" onclick="viewMessage('${msg.id}')">
                        <div class="message-avatar">${initials}</div>
                        <div class="message-content">
                            <div class="message-header">
                                <div>
                                    <div class="message-sender ${isUnread ? 'unread' : ''}">
                                        ${isSent ? 'To: ' : ''}${otherPerson?.name || 'Unknown'}
                                    </div>
                                    <div class="message-subject">${msg.subject}</div>
                                </div>
                                <div class="message-time">${formatTimeAgo(msg.created_at)}</div>
                            </div>
                            <div class="message-preview">
                                ${msg.message.substring(0, 100)}${msg.message.length > 100 ? '...' : ''}
                            </div>
                            ${msg.opportunity ? `
                                <div class="message-meta">
                                    <span class="message-tag">📌 ${msg.opportunity.title}</span>
                                </div>
                            ` : ''}
                        </div>
                        ${!isSent ? `
                            <div class="message-actions-quick">
                                <button class="quick-action-btn" onclick="event.stopPropagation(); quickReply('${msg.id}')">
                                    Quick Reply
                                </button>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        // Quick reply function
        function quickReply(messageId) {
            const message = allMessages.find(m => m.id === messageId);
            if (message) {
                showReplyModal(messageId);
            }
        }

        // View message with proper reply button
        async function viewMessage(messageId) {
            const message = allMessages.find(m => m.id === messageId);
            if (!message) return;

            currentMessage = message;

            // Mark as read if unread
            if (message.status === 'unread' && message.recipient_id === currentUser.id) {
                await window.covetalks.markMessageAsRead(messageId);
                message.status = 'read';
                await updateUnreadCount();
                displayMessages();
            }

            // Hide list, show message view
            document.getElementById('messagesList').style.display = 'none';
            const messageView = document.getElementById('messageView');
            messageView.classList.add('active');

            const isSent = message.sender_id === currentUser.id;
            const isReceived = message.recipient_id === currentUser.id;
            const otherPerson = isSent ? message.recipient : message.sender;

            messageView.innerHTML = `
                <div class="message-view-header">
                    <button onclick="backToList()" class="btn btn-secondary btn-sm" style="margin-bottom: 1rem;">
                        ← Back to Messages
                    </button>
                    <h2 class="message-view-subject">${message.subject}</h2>
                    <div class="message-view-meta">
                        <span><strong>${isSent ? 'To' : 'From'}:</strong> ${otherPerson?.name || 'Unknown'}</span>
                        <span><strong>Date:</strong> ${formatDateTime(message.created_at)}</span>
                        ${message.opportunity ? `
                            <span><strong>Related:</strong> ${message.opportunity.title}</span>
                        ` : ''}
                    </div>
                </div>
                <div class="message-view-body">${message.message}</div>
                <div class="message-actions">
                    ${isReceived ? `
                        <button onclick="showReplyModal('${message.id}')" class="btn btn-primary">
                            ↩️ Reply
                        </button>
                    ` : ''}
                    ${message.status !== 'archived' ? `
                        <button onclick="archiveMessage('${message.id}')" class="btn btn-secondary">
                            📁 Archive
                        </button>
                    ` : ''}
                </div>
            `;
        }

        // Back to list
        function backToList() {
            document.getElementById('messagesList').style.display = 'block';
            document.getElementById('messageView').classList.remove('active');
        }

        // Show compose modal with optional recipient
        function showComposeModal(recipientId = null, recipientName = null) {
            const modal = document.getElementById('composeModal');
            modal.classList.add('show');
            
            // Reset form
            document.getElementById('composeForm').reset();
            
            // Set recipient if provided
            if (recipientId && recipientName) {
                selectedRecipient = { id: recipientId, name: recipientName };
            }
            
            // Update recipient field
            if (selectedRecipient) {
                const recipientField = document.getElementById('recipientField');
                recipientField.innerHTML = `
                    <div class="selected-recipient">
                        <span class="recipient-tag">
                            ${selectedRecipient.name}
                            <button onclick="clearRecipient()" class="remove-btn">×</button>
                        </span>
                        <input type="hidden" id="recipientId" value="${selectedRecipient.id}">
                    </div>
                `;
            } else {
                setupRecipientSearch();
            }
        }

        // Setup recipient search with autocomplete
        function setupRecipientSearch() {
            const recipientField = document.getElementById('recipientField');
            recipientField.innerHTML = `
                <div class="recipient-search-container">
                    <span class="search-input-icon">🔍</span>
                    <input type="text" 
                           id="recipientSearch" 
                           placeholder="Start typing to search for members..." 
                           onkeyup="handleRecipientSearch(this.value)"
                           autocomplete="off">
                    <div id="recipientSuggestions" class="recipient-suggestions hidden"></div>
                </div>
                <input type="hidden" id="recipientId" value="">
            `;
            
            // Focus on the search field
            setTimeout(() => {
                document.getElementById('recipientSearch')?.focus();
            }, 100);
        }

        // Handle recipient search with debouncing
        function handleRecipientSearch(query) {
            clearTimeout(searchTimeout);
            
            const suggestions = document.getElementById('recipientSuggestions');
            
            if (!query || query.length < 2) {
                suggestions.classList.add('hidden');
                return;
            }
            
            // Show searching indicator
            suggestions.innerHTML = `
                <div class="searching-indicator">
                    <span class="searching-spinner"></span>
                    Searching...
                </div>
            `;
            suggestions.classList.remove('hidden');
            
            // Debounce search
            searchTimeout = setTimeout(() => {
                searchRecipients(query);
            }, 300);
        }

        // Search for recipients
        async function searchRecipients(query) {
            try {
                // Search members in database
                const { data: members, error } = await window.covetalks.supabase
                    .from('members')
                    .select('id, name, email, member_type')
                    .or(`name.ilike.%${query}%,email.ilike.%${query}%`)
                    .neq('id', currentUser.id) // Exclude current user
                    .limit(10);
                
                if (error) throw error;
                
                const suggestions = document.getElementById('recipientSuggestions');
                
                if (members && members.length > 0) {
                    suggestions.innerHTML = members.map(member => {
                        const initials = member.name ? 
                            member.name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2) : 
                            '??';
                        const badgeClass = member.member_type === 'Speaker' ? 'speaker' : 'organization';
                        
                        return `
                            <div class="suggestion-item" onclick="selectRecipient('${member.id}', '${member.name}', '${member.email}')">
                                <div class="suggestion-avatar">${initials}</div>
                                <div class="suggestion-info">
                                    <div class="suggestion-name">${member.name || 'Unknown'}</div>
                                    <div class="suggestion-email">${member.email}</div>
                                </div>
                                <span class="member-type-badge ${badgeClass}">${member.member_type}</span>
                            </div>
                        `;
                    }).join('');
                } else {
                    suggestions.innerHTML = `
                        <div class="no-results">
                            <p>No members found matching "${query}"</p>
                            <small>Try searching by name or email</small>
                        </div>
                    `;
                }
                
                suggestions.classList.remove('hidden');
            } catch (error) {
                console.error('Error searching recipients:', error);
                const suggestions = document.getElementById('recipientSuggestions');
                suggestions.innerHTML = '<div class="no-results">Error searching members. Please try again.</div>';
            }
        }

        // Select a recipient
        function selectRecipient(id, name, email) {
            selectedRecipient = { id, name, email };
            
            const recipientField = document.getElementById('recipientField');
            recipientField.innerHTML = `
                <div class="selected-recipient">
                    <span class="recipient-tag">
                        ${name}
                        <button onclick="clearRecipient()" class="remove-btn">×</button>
                    </span>
                    <input type="hidden" id="recipientId" value="${id}">
                </div>
            `;
            
            // Focus on subject field
            document.getElementById('subject').focus();
        }

        // Clear selected recipient
        function clearRecipient() {
            selectedRecipient = null;
            setupRecipientSearch();
        }

        // Send new message
        async function sendNewMessage() {
            const recipientId = selectedRecipient?.id || document.getElementById('recipientId')?.value;
            const subject = document.getElementById('subject').value.trim();
            const message = document.getElementById('message').value.trim();
            const opportunityId = document.getElementById('composeForm').dataset.opportunityId || null;
            
            // Validation
            if (!recipientId) {
                showNotification('Please select a recipient', 'error');
                return;
            }
            
            if (!subject) {
                showNotification('Please enter a subject', 'error');
                return;
            }
            
            if (!message) {
                showNotification('Please enter a message', 'error');
                return;
            }
            
            // Show loading state
            const sendBtn = document.getElementById('sendMessageBtn');
            const originalText = sendBtn.textContent;
            sendBtn.textContent = 'Sending...';
            sendBtn.disabled = true;
            
            try {
                // Send the message
                await window.covetalks.sendMessage(
                    recipientId,
                    subject,
                    message,
                    opportunityId
                );
                
                // Close modal and reset
                closeModal();
                document.getElementById('composeForm').reset();
                selectedRecipient = null;
                
                // Reload messages
                await loadMessages();
                
                // Show success message
                showNotification('✅ Message sent successfully!', 'success');
                
            } catch (error) {
                console.error('Error sending message:', error);
                showNotification('Failed to send message. Please try again.', 'error');
            } finally {
                sendBtn.textContent = originalText;
                sendBtn.disabled = false;
            }
        }

        // Show reply modal
        function showReplyModal(messageId) {
            const message = allMessages.find(m => m.id === messageId);
            if (!message) return;
            
            replyToMessage = message;
            document.getElementById('replyTo').textContent = message.sender?.name || 'Unknown';
            document.getElementById('replySubject').textContent = `Re: ${message.subject}`;
            document.getElementById('originalDate').textContent = formatDateTime(message.created_at);
            
            // Show original message in thread
            const quotedContent = message.message.length > 500 ? 
                message.message.substring(0, 500) + '...' : 
                message.message;
            document.getElementById('quotedMessage').textContent = quotedContent;
            
            // Clear reply textarea
            document.getElementById('replyMessage').value = '';
            
            document.getElementById('replyModal').classList.add('show');
            
            // Focus on reply textarea
            setTimeout(() => {
                document.getElementById('replyMessage').focus();
            }, 100);
        }

        // Send reply
        async function sendReply() {
            if (!replyToMessage) return;
            
            const messageContent = document.getElementById('replyMessage').value.trim();
            
            if (!messageContent) {
                showNotification('Please enter a reply message', 'error');
                return;
            }
            
            const sendBtn = document.getElementById('sendReplyBtn');
            const originalText = sendBtn.textContent;
            sendBtn.textContent = 'Sending...';
            sendBtn.disabled = true;
            
            try {
                await window.covetalks.sendMessage(
                    replyToMessage.sender_id,
                    `Re: ${replyToMessage.subject}`,
                    messageContent,
                    replyToMessage.opportunity_id
                );
                
                closeModal();
                await loadMessages();
                showNotification('✅ Reply sent successfully!', 'success');
                
            } catch (error) {
                console.error('Error sending reply:', error);
                showNotification('Failed to send reply', 'error');
            } finally {
                sendBtn.textContent = originalText;
                sendBtn.disabled = false;
            }
        }

        // Filter messages
        function filterMessages(folder) {
            currentFolder = folder;
            
            // Update menu
            document.querySelectorAll('.inbox-menu a').forEach(a => a.classList.remove('active'));
            event.target.closest('a').classList.add('active');
            
            // Update title
            const titles = {
                'inbox': 'Inbox',
                'sent': 'Sent Messages',
                'archived': 'Archived Messages'
            };
            document.getElementById('folderTitle').textContent = titles[folder] || 'Messages';
            
            // Display filtered messages
            displayMessages();
            backToList();
        }

        // Search messages
        function searchMessages() {
            const search = document.getElementById('searchMessages').value.toLowerCase();
            
            if (!search) {
                displayMessages();
                return;
            }
            
            // Filter and display
            const container = document.getElementById('messagesList');
            const filtered = allMessages.filter(msg => 
                msg.subject.toLowerCase().includes(search) ||
                msg.message.toLowerCase().includes(search) ||
                msg.sender?.name?.toLowerCase().includes(search) ||
                msg.recipient?.name?.toLowerCase().includes(search)
            );
            
            if (filtered.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">🔍</div>
                        <h3>No results found</h3>
                        <p>Try a different search term</p>
                    </div>
                `;
            } else {
                // Display filtered results (reuse display logic)
                displayMessages();
            }
        }

        // Archive message
        async function archiveMessage(messageId) {
            try {
                await window.covetalks.supabase
                    .from('messages')
                    .update({ status: 'archived' })
                    .eq('id', messageId);
                
                await loadMessages();
                backToList();
                showNotification('Message archived', 'info');
                
            } catch (error) {
                console.error('Error archiving message:', error);
                showNotification('Failed to archive message', 'error');
            }
        }

        // Update unread count
        async function updateUnreadCount() {
            const count = await window.covetalks.getUnreadMessageCount();
            
            if (count > 0) {
                document.getElementById('unreadBadge').textContent = count;
                document.getElementById('unreadBadge').classList.remove('hidden');
                document.getElementById('dropdownUnread').textContent = count;
                document.getElementById('dropdownUnread').classList.remove('hidden');
            } else {
                document.getElementById('unreadBadge').classList.add('hidden');
                document.getElementById('dropdownUnread').classList.add('hidden');
            }
        }

        // Show notification
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.innerHTML = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }

        // Close modal
        function closeModal() {
            document.getElementById('composeModal').classList.remove('show');
            document.getElementById('replyModal').classList.remove('show');
            
            // Clear URL parameters
            const url = new URL(window.location);
            url.searchParams.delete('compose');
            url.searchParams.delete('to');
            url.searchParams.delete('name');
            url.searchParams.delete('subject');
            url.searchParams.delete('opportunity');
            window.history.replaceState({}, document.title, url.pathname);
        }

        // Format time ago
        function formatTimeAgo(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            if (diffDays < 7) return `${diffDays}d ago`;
            return date.toLocaleDateString();
        }

        // Format date time
        function formatDateTime(dateString) {
            return new Date(dateString).toLocaleString('en-US', {
                month: 'short',
                day: 'numeric',
                year: 'numeric',
                hour: 'numeric',
                minute: '2-digit',
                hour12: true
            });
        }

        // Toggle dropdown
        function toggleDropdown() {
            const dropdown = document.getElementById('dropdownMenu');
            dropdown.classList.toggle('show');
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('dropdownMenu');
            const avatar = document.getElementById('userAvatar');
            
            if (!avatar.contains(event.target) && !dropdown.contains(event.target)) {
                dropdown.classList.remove('show');
            }
        });

        // Close modals when clicking outside
        document.addEventListener('click', function(event) {
            if (event.target.classList.contains('modal')) {
                closeModal();
            }
        });

        // Logout
        async function logout() {
            if (window.covetalks) {
                await window.covetalks.logout();
            }
        }

        // Initialize on load
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializePage);
        } else {
            initializePage();
        }
    </script>
</body>
</html>